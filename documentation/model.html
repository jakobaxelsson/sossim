<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.0.0"/>
    <title>model API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="index.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;
                Module Index
            </a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="variable" href="#Node">Node</a>
            </li>
            <li>
                    <a class="variable" href="#Edge">Edge</a>
            </li>
            <li>
                    <a class="variable" href="#directions">directions</a>
            </li>
            <li>
                    <a class="function" href="#node_to">node_to</a>
            </li>
            <li>
                    <a class="function" href="#direction">direction</a>
            </li>
            <li>
                    <a class="function" href="#subnode">subnode</a>
            </li>
            <li>
                    <a class="function" href="#supernode">supernode</a>
            </li>
            <li>
                    <a class="class" href="#GridNetworkSpace">GridNetworkSpace</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#GridNetworkSpace.__init__">GridNetworkSpace</a>
                        </li>
                        <li>
                                <a class="variable" href="#GridNetworkSpace.size_x">size_x</a>
                        </li>
                        <li>
                                <a class="variable" href="#GridNetworkSpace.size_y">size_y</a>
                        </li>
                        <li>
                                <a class="variable" href="#GridNetworkSpace.road_density">road_density</a>
                        </li>
                        <li>
                                <a class="variable" href="#GridNetworkSpace.coarse_network">coarse_network</a>
                        </li>
                        <li>
                                <a class="variable" href="#GridNetworkSpace.road_network">road_network</a>
                        </li>
                        <li>
                                <a class="function" href="#GridNetworkSpace.generate_roads">generate_roads</a>
                        </li>
                        <li>
                                <a class="function" href="#GridNetworkSpace.add_edges">add_edges</a>
                        </li>
                        <li>
                                <a class="function" href="#GridNetworkSpace.grid_neighbours">grid_neighbours</a>
                        </li>
                        <li>
                                <a class="function" href="#GridNetworkSpace.generate_destinations">generate_destinations</a>
                        </li>
                        <li>
                                <a class="function" href="#GridNetworkSpace.priority_nodes">priority_nodes</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Vehicle">Vehicle</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Vehicle.__init__">Vehicle</a>
                        </li>
                        <li>
                                <a class="variable" href="#Vehicle.capacity">capacity</a>
                        </li>
                        <li>
                                <a class="variable" href="#Vehicle.pos">pos</a>
                        </li>
                        <li>
                                <a class="variable" href="#Vehicle.new_pos">new_pos</a>
                        </li>
                        <li>
                                <a class="variable" href="#Vehicle.heading">heading</a>
                        </li>
                        <li>
                                <a class="variable" href="#Vehicle.plan">plan</a>
                        </li>
                        <li>
                                <a class="function" href="#Vehicle.create_plan">create_plan</a>
                        </li>
                        <li>
                                <a class="function" href="#Vehicle.step">step</a>
                        </li>
                        <li>
                                <a class="function" href="#Vehicle.advance">advance</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#TransportSystem">TransportSystem</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#TransportSystem.__init__">TransportSystem</a>
                        </li>
                        <li>
                                <a class="variable" href="#TransportSystem.view">view</a>
                        </li>
                        <li>
                                <a class="variable" href="#TransportSystem.num_agents">num_agents</a>
                        </li>
                        <li>
                                <a class="variable" href="#TransportSystem.width">width</a>
                        </li>
                        <li>
                                <a class="variable" href="#TransportSystem.height">height</a>
                        </li>
                        <li>
                                <a class="variable" href="#TransportSystem.random_seed">random_seed</a>
                        </li>
                        <li>
                                <a class="function" href="#TransportSystem.add_view">add_view</a>
                        </li>
                        <li>
                                <a class="function" href="#TransportSystem.generate">generate</a>
                        </li>
                        <li>
                                <a class="function" href="#TransportSystem.step">step</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
model    </h1>

                        <div class="docstring"><p>Provides models, agents, and spaces for the SoSSim system-of-systems simulator.</p>
</div>

                        <input id="mod-model-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-model-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="sd">Provides models, agents, and spaces for the SoSSim system-of-systems simulator.</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">import</span> <span class="nn">math</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">import</span> <span class="nn">random</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">import</span> <span class="nn">sys</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="kn">import</span> <span class="nn">capabilities</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="kn">import</span> <span class="nn">mesa</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="c1"># Type abbreviations for nodes and edges</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="n">Node</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="n">Edge</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Node</span><span class="p">,</span> <span class="n">Node</span><span class="p">]</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="c1"># Auxiliary functions to calculate neighbours of a coordinate in the grid.</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="n">directions</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;N&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;E&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;S&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;W&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)}</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="k">def</span> <span class="nf">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Node</span><span class="p">:</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">    Returns the node neighbouring the given node in the given direction</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="sd">    Args:</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">        node (Node): the starting node.</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">        direction (str): the direction, which is &quot;N&quot;, &quot;E&quot;, &quot;S&quot;, &quot;W&quot;.</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="sd">    Returns:</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="sd">        Node: the neighbouring node.</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>    <span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span> <span class="o">=</span> <span class="n">directions</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>    <span class="k">return</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dy</span><span class="p">)</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="k">def</span> <span class="nf">direction</span><span class="p">(</span><span class="n">from_node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">to_node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">    Returns the direction from one node to an adjacent node.</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="sd">    Args:</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">        from_node (Node): the source node.</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">        to_node (Node): the sink node.</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">    Returns:</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">        str: direction as one of the strings &quot;N&quot;, &quot;E&quot;, &quot;S&quot;, &quot;W&quot;</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>    <span class="n">inverse_directions</span> <span class="o">=</span> <span class="p">{</span> <span class="n">value</span> <span class="p">:</span> <span class="n">key</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">directions</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">}</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>    <span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">from_node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">to_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span>  <span class="n">from_node</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>    <span class="k">return</span> <span class="n">inverse_directions</span><span class="p">[(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)]</span>    
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="k">def</span> <span class="nf">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">j</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Node</span><span class="p">:</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">    Returns the detailed network subnode (i, j) of a coarse network node.</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>    <span class="k">return</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="k">def</span> <span class="nf">supernode</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Node</span><span class="p">:</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="sd">    Returns the coarse network node corresponding to a detailed road network node.</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>    <span class="k">return</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">4</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">4</span><span class="p">)</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="k">class</span> <span class="nc">GridNetworkSpace</span><span class="p">:</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">    A mesa space consisting of a road network which is placed on a grid.</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="sd">    The road network is a networkx graph, where node names are tuples (x, y) referring to grid positions.</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="sd">    Some nodes in the road networks can be destinations, where places of interest can be placed.</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">road_density</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">):</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a><span class="sd">        Creates a grid of size (x, y), and adds a road network to it.</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a><span class="sd">        </span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="sd">        Args:</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="sd">            x (int, optional): the grid size in the x dimension. Defaults to 10.</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="sd">            y (int, optional): the grid size in the y dimension. Defaults to 10.</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a><span class="sd">            road_density (float, optional): the proportion of grid elements to be connected by roads. Defaults to 0.3.</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>        <span class="c1"># Setup parameters</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size_x</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span> <span class="o">=</span> <span class="n">y</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">road_density</span> <span class="o">=</span> <span class="n">road_density</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coarse_network</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">road_network</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>        <span class="c1"># Generate roads and destinations</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_roads</span><span class="p">()</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_destinations</span><span class="p">()</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>    <span class="k">def</span> <span class="nf">generate_roads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a><span class="sd">        Generates the road network. This is a two step process.</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="sd">        First, a coarse undirected network is generated, where each node corresponds to a grid cell.</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="sd">        Heustistics are used to try to spread this network over the grid and have a balance between dense and sprawling roads.</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a><span class="sd">        Second, this network is expanded into a directed graph, containing separate roadways and roundabouts.</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a><span class="sd">        This is achieved by dividing each coarse network node / grid cell into 4 x 4 subnodes.</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a><span class="sd">        These are connected so that traffic in all directions become possible.</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a><span class="sd">        In the resulting directed network, each node has either one or two outgoing edges.</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="sd">        The network keeps track of what agents are currently in a node.</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>        <span class="n">cnw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_network</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>        <span class="c1"># Step 1. Create a connected graph whose nodes are a subset of the grid cells.</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>        <span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size_x</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span> <span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>        <span class="n">edge_candidates</span> <span class="o">=</span> <span class="p">[(</span><span class="n">node</span><span class="p">,</span> <span class="n">neighbour</span><span class="p">)</span> <span class="k">for</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_neighbours</span><span class="p">(</span><span class="n">node</span><span class="p">)]</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>        <span class="c1"># The number of nodes is determined by the road_density parameter.</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>        <span class="k">while</span> <span class="n">nx</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">(</span><span class="n">cnw</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">road_density</span><span class="p">:</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>            <span class="c1"># Pick an edge to add, removing it from the candidates and adding it to the graph</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>            <span class="n">edge</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">edge_candidates</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_edge_preference</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edge_candidates</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>            <span class="c1"># If the sink of the new edge is new in the graph, add edges to its neighbours as new edge candidates</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>            <span class="n">node</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">cnw</span><span class="o">.</span><span class="n">has_node</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>                <span class="n">edge_candidates</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">node</span><span class="p">,</span> <span class="n">neighbour</span><span class="p">)</span> <span class="k">for</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_neighbours</span><span class="p">(</span><span class="n">node</span><span class="p">)]</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>            <span class="c1"># Add the new edge (and implicitly its nodes), and remove the edge as a candidate.</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>            <span class="n">cnw</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>            <span class="n">edge_candidates</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>        <span class="c1"># Step 2. Add lanes and roundabouts.</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>        <span class="c1"># Create a new graph, this time directed. Each node in the coarse graph maps to 4 x 4 nodes in the new graph.</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>        <span class="n">rnw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">road_network</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>        <span class="c1"># Add internal connections between coarse node in detailed graph.</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">:</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>            <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># East</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;EEE&quot;</span><span class="p">)</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>            <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># West</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;WWW&quot;</span><span class="p">)</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>            <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># North</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;NNN&quot;</span><span class="p">)</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>            <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># South</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;SSS&quot;</span><span class="p">)</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>        <span class="c1"># Add connections for roundabouts and through roads</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">:</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>            <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">node</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>            <span class="k">if</span> <span class="n">cnw</span><span class="o">.</span><span class="n">degree</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>                <span class="c1"># Dead ends need to make it possible to turn around, which requires adding three out of four edges.</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># No eastern neighbour</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;N&quot;</span><span class="p">)</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># No western neighbour</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># No northern neighbour</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;W&quot;</span><span class="p">)</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># No southern neighbour</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>            <span class="k">if</span> <span class="n">cnw</span><span class="o">.</span><span class="n">degree</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>                <span class="c1"># Through roads</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># Northern and western neighbours</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;EN&quot;</span><span class="p">)</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># Northern and southern neighbours</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;N&quot;</span><span class="p">)</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># Northern and eastern neighbours</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;SE&quot;</span><span class="p">)</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># Western and southern neighbours</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;NW&quot;</span><span class="p">)</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># Western and eastern neighbours</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;W&quot;</span><span class="p">)</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># Southern and eastern neighbours</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;WS&quot;</span><span class="p">)</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>            <span class="k">if</span> <span class="n">cnw</span><span class="o">.</span><span class="n">degree</span><span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>                <span class="c1"># Three and four way crossings require roundabouts, so all four edges are added.</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;SENW&quot;</span><span class="p">)</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>        <span class="c1"># Keep track of all agents in a node</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">rnw</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>            <span class="n">rnw</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;agent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>    <span class="k">def</span> <span class="nf">add_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">directions</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a><span class="sd">        Adds a sequence of edges to the road network, starting in the provided node and going in the provided directions.</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a><span class="sd">        Args:</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a><span class="sd">            node (Node): the start node.</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a><span class="sd">            directions (str): the direction, which is a string containing the characters N, E, S, W</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>        <span class="n">rnw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">road_network</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">directions</span><span class="p">:</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>            <span class="n">next_node</span> <span class="o">=</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>            <span class="n">rnw</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">next_node</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="n">d</span><span class="p">)</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>            <span class="n">node</span> <span class="o">=</span> <span class="n">next_node</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>    <span class="k">def</span> <span class="nf">_edge_preference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge</span><span class="p">:</span> <span class="n">Edge</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a><span class="sd">        Provides a heuristic for adding edges to the coarse network during generation.</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a><span class="sd">        It assigns a random preference to the provided edge depending on where it is on the grid and the connecting nodes previous edges.</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a><span class="sd">        Args:</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a><span class="sd">            edge (Edge): the edge.</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a><span class="sd">        Returns:</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a><span class="sd">            float: a number indicating how preferred this edge is.</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>        <span class="c1"># Returns a numerical value indicating how preferred this edge is (higher means more likely to be selected)</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a>        <span class="n">cnw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_network</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>        <span class="c1"># Count number of existing edges for the source and sink of the selected edge</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>        <span class="n">nb_source_edges</span> <span class="o">=</span> <span class="n">cnw</span><span class="o">.</span><span class="n">degree</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">cnw</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>        <span class="n">nb_sink_edges</span> <span class="o">=</span> <span class="n">cnw</span><span class="o">.</span><span class="n">degree</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">if</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">cnw</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>        <span class="c1"># Count distance of sink from center of world normalized with respect to the size of the world</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>        <span class="n">dist_x</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_x</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>        <span class="n">dist_y</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>        <span class="n">norm_dist</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dist_x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dist_y</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">size_x</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size_y</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>        <span class="c1"># Prefer adding edges away from the center and adding new nodes (a small epsilon is added to ensure that weights &gt; 0)</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>        <span class="k">return</span> <span class="mi">50</span> <span class="o">*</span> <span class="n">norm_dist</span> <span class="o">/</span> <span class="p">(</span><span class="n">nb_source_edges</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">nb_sink_edges</span> <span class="o">+</span> <span class="mf">0.00001</span><span class="p">)</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>        
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>    <span class="k">def</span> <span class="nf">grid_neighbours</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]:</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a><span class="sd">        Returns the grid neighbours of a node, taking coarse network grid boundaries into accound.</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a><span class="sd">        Diagonal neighbours are not considered.</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a><span class="sd">        Args:</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a><span class="sd">            node (Node): the node.</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a><span class="sd">        Returns:</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a><span class="sd">            List[Node]: the neighbours.</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>        <span class="k">return</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="s2">&quot;EWSN&quot;</span><span class="p">]</span> 
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>                <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_x</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span><span class="p">]</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>    <span class="k">def</span> <span class="nf">generate_destinations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probability</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a><span class="sd">        Determines which nodes in the road network should be destinations.</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a><span class="sd">        Only nodes with exactly one ingoing and one outgoing edge can be a destination.</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a><span class="sd">        This is to disallow destinations in crossings.</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a><span class="sd">        </span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a><span class="sd">        Args:</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a><span class="sd">            probability (float, optional): The probability that an eligible node will be selected as a destination. Defaults to 1.</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>        <span class="c1"># TODO: This requires some polishing.</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>        <span class="n">rnw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">road_network</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">rnw</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>            <span class="k">if</span> <span class="n">rnw</span><span class="o">.</span><span class="n">in_degree</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">rnw</span><span class="o">.</span><span class="n">out_degree</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">probability</span><span class="p">:</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>                <span class="n">rnw</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;destination&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>                <span class="n">rnw</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;destination&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>    <span class="k">def</span> <span class="nf">priority_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">to_node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]:</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a><span class="sd">        Returns the nodes from which traffic has priority over from_node when going into to_node.</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a><span class="sd">        Args:</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a><span class="sd">            from_node (Node): the node to be checked for priority.</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a><span class="sd">            to_node (Node): the node to be checked for priority.</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a><span class="sd">        Returns:</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a><span class="sd">            List[Node]: a list of nodes from which vehicles have priority.</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>        <span class="c1"># In a roundabout, W has priority over S, S over E, E over N and N over W.</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>        <span class="n">priority_rule</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;W&quot;</span> <span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span> <span class="p">:</span> <span class="s2">&quot;E&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span> <span class="p">:</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span> <span class="p">:</span> <span class="s2">&quot;W&quot;</span> <span class="p">}</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>        <span class="c1"># Determine which node has priority entering to_node.</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>        <span class="n">priority_direction</span> <span class="o">=</span> <span class="n">priority_rule</span><span class="p">[</span><span class="n">direction</span><span class="p">(</span><span class="n">from_node</span><span class="p">,</span> <span class="n">to_node</span><span class="p">)]</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>        <span class="n">priority_node</span> <span class="o">=</span> <span class="n">node_to</span><span class="p">(</span><span class="n">to_node</span><span class="p">,</span> <span class="n">priority_direction</span><span class="p">)</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>        <span class="c1"># If the priority node can reach to_node, return it, otherwise return nothing.</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">road_network</span><span class="o">.</span><span class="n">has_edge</span><span class="p">(</span><span class="n">priority_node</span><span class="p">,</span> <span class="n">to_node</span><span class="p">):</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>            <span class="k">return</span> <span class="p">[</span><span class="n">priority_node</span><span class="p">]</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a><span class="k">class</span> <span class="nc">Vehicle</span><span class="p">(</span><span class="n">mesa</span><span class="o">.</span><span class="n">Agent</span><span class="p">):</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unique_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">mesa</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a><span class="sd">        Creates a vehicle agent in a simulation model.</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a><span class="sd">        Args:</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a><span class="sd">            unique_id (int): the unique id of the agent.</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a><span class="sd">            model (mesa.Model): the model in which the agent is situated.</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">unique_id</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>        <span class="c1"># Add a load capacity of the vehicle</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>        <span class="c1"># Randomly select a starting position which is not yet occupied by some other vehicle.</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>        <span class="n">rnw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">road_network</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>        <span class="n">available_positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">rnw</span><span class="o">.</span><span class="n">nodes</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">rnw</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s2">&quot;agent&quot;</span><span class="p">]]</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">available_positions</span><span class="p">)</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>        <span class="n">rnw</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">][</span><span class="s2">&quot;agent&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">new_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>        <span class="c1"># Set the initial heading of the vehicle.</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">heading</span> <span class="o">=</span> <span class="n">rnw</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">][</span><span class="nb">next</span><span class="p">(</span><span class="n">rnw</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">))][</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>        <span class="c1"># Add a view</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">view</span><span class="p">:</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">create_agent_view</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>        <span class="c1"># Add a plan, which is a list of capability instances.</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plan</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>    <span class="k">def</span> <span class="nf">create_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a><span class="sd">        The vehicle creates a plan, which consists of randomly moving to one the neighbours in the road network.</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>        <span class="n">rnw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">road_network</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>        <span class="n">new_pos</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">rnw</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)))</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plan</span> <span class="o">=</span> <span class="p">[</span><span class="n">capabilities</span><span class="o">.</span><span class="n">MoveCapability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_pos</span><span class="p">)]</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a><span class="sd">        The first part of a simulation round when using the Mesa simultaneous activation scheduler.</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a><span class="sd">        If the agent does not have a plan, it creates one.</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a><span class="sd">        Then it checks that the preconditions of the first action in the plan are fulfilled.</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">:</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">create_plan</span><span class="p">()</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>        <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ready_to_advance</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">precondition</span><span class="p">()</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>    <span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a><span class="sd">        The second part of a simulation round when using the Mesa simultaneous activation scheduler.</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a><span class="sd">        If the precondition of the first action in the current plan was fullfilled, that action is now carried out.</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a><span class="sd">        If this leads to the action&#39;s postcondition being fulfilled, the action is removed from the plan.</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a><span class="sd">        Finally, if the agent has a view, that view is updated.</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>        <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ready_to_advance</span><span class="p">:</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>            <span class="n">action</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>        <span class="k">if</span> <span class="n">action</span><span class="o">.</span><span class="n">postcondition</span><span class="p">():</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>        <span class="c1"># Update the position in the drawing</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">view</span><span class="p">:</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a><span class="k">class</span> <span class="nc">TransportSystem</span><span class="p">(</span><span class="n">mesa</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a><span class="sd">        Creates a transport system model.</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a><span class="sd">        Note that it is empty initially, and needs to be generated using the generate method.</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>        <span class="c1"># TODO: Initialize from a configuration object, to make it easier to edit, load, and save it.</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>        <span class="c1"># TODO: Mesa has its own random seed handling, see source code of Mesa.model. </span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_agents</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">)</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>    <span class="k">def</span> <span class="nf">add_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a><span class="sd">        Adds a view to the model.</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a><span class="sd">        Args:</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a><span class="sd">            view (Any): the view to be added.</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">view</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a><span class="sd">        Generates the model, including creating its space and agents.</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a><span class="sd">        Args:</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a><span class="sd">            N (int, optional): number of agents. Defaults to 10.</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a><span class="sd">            width (int, optional): width of the coarse grid space. Defaults to 10.</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a><span class="sd">            height (int, optional): height of the coarse grid space. Defaults to 10.</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a><span class="sd">            random_seed (int | None, optional): a random seed. Defaults to None, in which case a seed is generated.</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_agents</span> <span class="o">=</span> <span class="n">N</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="n">random_seed</span> <span class="ow">or</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">)</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span> <span class="o">=</span> <span class="n">mesa</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">SimultaneousActivation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">space</span> <span class="o">=</span> <span class="n">GridNetworkSpace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">:</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>        <span class="c1"># Create agents</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_agents</span><span class="p">):</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>            <span class="n">a</span> <span class="o">=</span> <span class="n">Vehicle</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a><span class="sd">        Performs a simulation step and updates the views.</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">:</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">update_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="Node">
                    <div class="attr variable">
            <span class="name">Node</span>        =
<span class="default_value">typing.Tuple[int, int]</span>

        
    </div>
    <a class="headerlink" href="#Node"></a>
    
    

                </section>
                <section id="Edge">
                    <div class="attr variable">
            <span class="name">Edge</span>        =
<span class="default_value">typing.Tuple[typing.Tuple[int, int], typing.Tuple[int, int]]</span>

        
    </div>
    <a class="headerlink" href="#Edge"></a>
    
    

                </section>
                <section id="directions">
                    <div class="attr variable">
            <span class="name">directions</span>        =
<span class="default_value">{&#39;N&#39;: (0, -1), &#39;E&#39;: (1, 0), &#39;S&#39;: (0, 1), &#39;W&#39;: (-1, 0)}</span>

        
    </div>
    <a class="headerlink" href="#directions"></a>
    
    

                </section>
                <section id="node_to">
                            <input id="node_to-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">node_to</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">node</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>, </span><span class="param"><span class="n">direction</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="node_to-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#node_to"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="node_to-24"><a href="#node_to-24"><span class="linenos">24</span></a><span class="k">def</span> <span class="nf">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Node</span><span class="p">:</span>
</span><span id="node_to-25"><a href="#node_to-25"><span class="linenos">25</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="node_to-26"><a href="#node_to-26"><span class="linenos">26</span></a><span class="sd">    Returns the node neighbouring the given node in the given direction</span>
</span><span id="node_to-27"><a href="#node_to-27"><span class="linenos">27</span></a>
</span><span id="node_to-28"><a href="#node_to-28"><span class="linenos">28</span></a><span class="sd">    Args:</span>
</span><span id="node_to-29"><a href="#node_to-29"><span class="linenos">29</span></a><span class="sd">        node (Node): the starting node.</span>
</span><span id="node_to-30"><a href="#node_to-30"><span class="linenos">30</span></a><span class="sd">        direction (str): the direction, which is &quot;N&quot;, &quot;E&quot;, &quot;S&quot;, &quot;W&quot;.</span>
</span><span id="node_to-31"><a href="#node_to-31"><span class="linenos">31</span></a>
</span><span id="node_to-32"><a href="#node_to-32"><span class="linenos">32</span></a><span class="sd">    Returns:</span>
</span><span id="node_to-33"><a href="#node_to-33"><span class="linenos">33</span></a><span class="sd">        Node: the neighbouring node.</span>
</span><span id="node_to-34"><a href="#node_to-34"><span class="linenos">34</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="node_to-35"><a href="#node_to-35"><span class="linenos">35</span></a>    <span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span> <span class="o">=</span> <span class="n">directions</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span>
</span><span id="node_to-36"><a href="#node_to-36"><span class="linenos">36</span></a>    <span class="k">return</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dx</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dy</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Returns the node neighbouring the given node in the given direction</p>

<p>Args:
    node (Node): the starting node.
    direction (str): the direction, which is "N", "E", "S", "W".</p>

<p>Returns:
    Node: the neighbouring node.</p>
</div>


                </section>
                <section id="direction">
                            <input id="direction-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">direction</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">from_node</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>, </span><span class="param"><span class="n">to_node</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="nb">str</span>:</span></span>

                <label class="view-source-button" for="direction-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#direction"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="direction-38"><a href="#direction-38"><span class="linenos">38</span></a><span class="k">def</span> <span class="nf">direction</span><span class="p">(</span><span class="n">from_node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">to_node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="direction-39"><a href="#direction-39"><span class="linenos">39</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="direction-40"><a href="#direction-40"><span class="linenos">40</span></a><span class="sd">    Returns the direction from one node to an adjacent node.</span>
</span><span id="direction-41"><a href="#direction-41"><span class="linenos">41</span></a>
</span><span id="direction-42"><a href="#direction-42"><span class="linenos">42</span></a><span class="sd">    Args:</span>
</span><span id="direction-43"><a href="#direction-43"><span class="linenos">43</span></a><span class="sd">        from_node (Node): the source node.</span>
</span><span id="direction-44"><a href="#direction-44"><span class="linenos">44</span></a><span class="sd">        to_node (Node): the sink node.</span>
</span><span id="direction-45"><a href="#direction-45"><span class="linenos">45</span></a>
</span><span id="direction-46"><a href="#direction-46"><span class="linenos">46</span></a><span class="sd">    Returns:</span>
</span><span id="direction-47"><a href="#direction-47"><span class="linenos">47</span></a><span class="sd">        str: direction as one of the strings &quot;N&quot;, &quot;E&quot;, &quot;S&quot;, &quot;W&quot;</span>
</span><span id="direction-48"><a href="#direction-48"><span class="linenos">48</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="direction-49"><a href="#direction-49"><span class="linenos">49</span></a>    <span class="n">inverse_directions</span> <span class="o">=</span> <span class="p">{</span> <span class="n">value</span> <span class="p">:</span> <span class="n">key</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">directions</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">}</span>
</span><span id="direction-50"><a href="#direction-50"><span class="linenos">50</span></a>    <span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">to_node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">from_node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">to_node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span>  <span class="n">from_node</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="direction-51"><a href="#direction-51"><span class="linenos">51</span></a>    <span class="k">return</span> <span class="n">inverse_directions</span><span class="p">[(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)]</span>    
</span></pre></div>


            <div class="docstring"><p>Returns the direction from one node to an adjacent node.</p>

<p>Args:
    from_node (Node): the source node.
    to_node (Node): the sink node.</p>

<p>Returns:
    str: direction as one of the strings "N", "E", "S", "W"</p>
</div>


                </section>
                <section id="subnode">
                            <input id="subnode-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">subnode</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">node</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>, </span><span class="param"><span class="n">i</span><span class="p">:</span> <span class="nb">int</span>, </span><span class="param"><span class="n">j</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="subnode-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#subnode"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="subnode-53"><a href="#subnode-53"><span class="linenos">53</span></a><span class="k">def</span> <span class="nf">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">j</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Node</span><span class="p">:</span>
</span><span id="subnode-54"><a href="#subnode-54"><span class="linenos">54</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="subnode-55"><a href="#subnode-55"><span class="linenos">55</span></a><span class="sd">    Returns the detailed network subnode (i, j) of a coarse network node.</span>
</span><span id="subnode-56"><a href="#subnode-56"><span class="linenos">56</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="subnode-57"><a href="#subnode-57"><span class="linenos">57</span></a>    <span class="k">return</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Returns the detailed network subnode (i, j) of a coarse network node.</p>
</div>


                </section>
                <section id="supernode">
                            <input id="supernode-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">supernode</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">node</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="supernode-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#supernode"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="supernode-59"><a href="#supernode-59"><span class="linenos">59</span></a><span class="k">def</span> <span class="nf">supernode</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Node</span><span class="p">:</span>
</span><span id="supernode-60"><a href="#supernode-60"><span class="linenos">60</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="supernode-61"><a href="#supernode-61"><span class="linenos">61</span></a><span class="sd">    Returns the coarse network node corresponding to a detailed road network node.</span>
</span><span id="supernode-62"><a href="#supernode-62"><span class="linenos">62</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="supernode-63"><a href="#supernode-63"><span class="linenos">63</span></a>    <span class="k">return</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">4</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">4</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Returns the coarse network node corresponding to a detailed road network node.</p>
</div>


                </section>
                <section id="GridNetworkSpace">
                            <input id="GridNetworkSpace-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">GridNetworkSpace</span>:

                <label class="view-source-button" for="GridNetworkSpace-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GridNetworkSpace"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GridNetworkSpace-65"><a href="#GridNetworkSpace-65"><span class="linenos"> 65</span></a><span class="k">class</span> <span class="nc">GridNetworkSpace</span><span class="p">:</span>
</span><span id="GridNetworkSpace-66"><a href="#GridNetworkSpace-66"><span class="linenos"> 66</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace-67"><a href="#GridNetworkSpace-67"><span class="linenos"> 67</span></a><span class="sd">    A mesa space consisting of a road network which is placed on a grid.</span>
</span><span id="GridNetworkSpace-68"><a href="#GridNetworkSpace-68"><span class="linenos"> 68</span></a><span class="sd">    The road network is a networkx graph, where node names are tuples (x, y) referring to grid positions.</span>
</span><span id="GridNetworkSpace-69"><a href="#GridNetworkSpace-69"><span class="linenos"> 69</span></a><span class="sd">    Some nodes in the road networks can be destinations, where places of interest can be placed.</span>
</span><span id="GridNetworkSpace-70"><a href="#GridNetworkSpace-70"><span class="linenos"> 70</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace-71"><a href="#GridNetworkSpace-71"><span class="linenos"> 71</span></a>
</span><span id="GridNetworkSpace-72"><a href="#GridNetworkSpace-72"><span class="linenos"> 72</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">road_density</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">):</span>
</span><span id="GridNetworkSpace-73"><a href="#GridNetworkSpace-73"><span class="linenos"> 73</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace-74"><a href="#GridNetworkSpace-74"><span class="linenos"> 74</span></a><span class="sd">        Creates a grid of size (x, y), and adds a road network to it.</span>
</span><span id="GridNetworkSpace-75"><a href="#GridNetworkSpace-75"><span class="linenos"> 75</span></a><span class="sd">        </span>
</span><span id="GridNetworkSpace-76"><a href="#GridNetworkSpace-76"><span class="linenos"> 76</span></a><span class="sd">        Args:</span>
</span><span id="GridNetworkSpace-77"><a href="#GridNetworkSpace-77"><span class="linenos"> 77</span></a><span class="sd">            x (int, optional): the grid size in the x dimension. Defaults to 10.</span>
</span><span id="GridNetworkSpace-78"><a href="#GridNetworkSpace-78"><span class="linenos"> 78</span></a><span class="sd">            y (int, optional): the grid size in the y dimension. Defaults to 10.</span>
</span><span id="GridNetworkSpace-79"><a href="#GridNetworkSpace-79"><span class="linenos"> 79</span></a><span class="sd">            road_density (float, optional): the proportion of grid elements to be connected by roads. Defaults to 0.3.</span>
</span><span id="GridNetworkSpace-80"><a href="#GridNetworkSpace-80"><span class="linenos"> 80</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace-81"><a href="#GridNetworkSpace-81"><span class="linenos"> 81</span></a>        <span class="c1"># Setup parameters</span>
</span><span id="GridNetworkSpace-82"><a href="#GridNetworkSpace-82"><span class="linenos"> 82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size_x</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="GridNetworkSpace-83"><a href="#GridNetworkSpace-83"><span class="linenos"> 83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span> <span class="o">=</span> <span class="n">y</span>
</span><span id="GridNetworkSpace-84"><a href="#GridNetworkSpace-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">road_density</span> <span class="o">=</span> <span class="n">road_density</span>
</span><span id="GridNetworkSpace-85"><a href="#GridNetworkSpace-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coarse_network</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GridNetworkSpace-86"><a href="#GridNetworkSpace-86"><span class="linenos"> 86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">road_network</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GridNetworkSpace-87"><a href="#GridNetworkSpace-87"><span class="linenos"> 87</span></a>
</span><span id="GridNetworkSpace-88"><a href="#GridNetworkSpace-88"><span class="linenos"> 88</span></a>        <span class="c1"># Generate roads and destinations</span>
</span><span id="GridNetworkSpace-89"><a href="#GridNetworkSpace-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_roads</span><span class="p">()</span>
</span><span id="GridNetworkSpace-90"><a href="#GridNetworkSpace-90"><span class="linenos"> 90</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_destinations</span><span class="p">()</span>
</span><span id="GridNetworkSpace-91"><a href="#GridNetworkSpace-91"><span class="linenos"> 91</span></a>
</span><span id="GridNetworkSpace-92"><a href="#GridNetworkSpace-92"><span class="linenos"> 92</span></a>    <span class="k">def</span> <span class="nf">generate_roads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="GridNetworkSpace-93"><a href="#GridNetworkSpace-93"><span class="linenos"> 93</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace-94"><a href="#GridNetworkSpace-94"><span class="linenos"> 94</span></a><span class="sd">        Generates the road network. This is a two step process.</span>
</span><span id="GridNetworkSpace-95"><a href="#GridNetworkSpace-95"><span class="linenos"> 95</span></a><span class="sd">        First, a coarse undirected network is generated, where each node corresponds to a grid cell.</span>
</span><span id="GridNetworkSpace-96"><a href="#GridNetworkSpace-96"><span class="linenos"> 96</span></a><span class="sd">        Heustistics are used to try to spread this network over the grid and have a balance between dense and sprawling roads.</span>
</span><span id="GridNetworkSpace-97"><a href="#GridNetworkSpace-97"><span class="linenos"> 97</span></a><span class="sd">        Second, this network is expanded into a directed graph, containing separate roadways and roundabouts.</span>
</span><span id="GridNetworkSpace-98"><a href="#GridNetworkSpace-98"><span class="linenos"> 98</span></a><span class="sd">        This is achieved by dividing each coarse network node / grid cell into 4 x 4 subnodes.</span>
</span><span id="GridNetworkSpace-99"><a href="#GridNetworkSpace-99"><span class="linenos"> 99</span></a><span class="sd">        These are connected so that traffic in all directions become possible.</span>
</span><span id="GridNetworkSpace-100"><a href="#GridNetworkSpace-100"><span class="linenos">100</span></a><span class="sd">        In the resulting directed network, each node has either one or two outgoing edges.</span>
</span><span id="GridNetworkSpace-101"><a href="#GridNetworkSpace-101"><span class="linenos">101</span></a><span class="sd">        The network keeps track of what agents are currently in a node.</span>
</span><span id="GridNetworkSpace-102"><a href="#GridNetworkSpace-102"><span class="linenos">102</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace-103"><a href="#GridNetworkSpace-103"><span class="linenos">103</span></a>        <span class="n">cnw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_network</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
</span><span id="GridNetworkSpace-104"><a href="#GridNetworkSpace-104"><span class="linenos">104</span></a>
</span><span id="GridNetworkSpace-105"><a href="#GridNetworkSpace-105"><span class="linenos">105</span></a>        <span class="c1"># Step 1. Create a connected graph whose nodes are a subset of the grid cells.</span>
</span><span id="GridNetworkSpace-106"><a href="#GridNetworkSpace-106"><span class="linenos">106</span></a>        <span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size_x</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span> <span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</span><span id="GridNetworkSpace-107"><a href="#GridNetworkSpace-107"><span class="linenos">107</span></a>        <span class="n">edge_candidates</span> <span class="o">=</span> <span class="p">[(</span><span class="n">node</span><span class="p">,</span> <span class="n">neighbour</span><span class="p">)</span> <span class="k">for</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_neighbours</span><span class="p">(</span><span class="n">node</span><span class="p">)]</span>
</span><span id="GridNetworkSpace-108"><a href="#GridNetworkSpace-108"><span class="linenos">108</span></a>
</span><span id="GridNetworkSpace-109"><a href="#GridNetworkSpace-109"><span class="linenos">109</span></a>        <span class="c1"># The number of nodes is determined by the road_density parameter.</span>
</span><span id="GridNetworkSpace-110"><a href="#GridNetworkSpace-110"><span class="linenos">110</span></a>        <span class="k">while</span> <span class="n">nx</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">(</span><span class="n">cnw</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">road_density</span><span class="p">:</span>
</span><span id="GridNetworkSpace-111"><a href="#GridNetworkSpace-111"><span class="linenos">111</span></a>            <span class="c1"># Pick an edge to add, removing it from the candidates and adding it to the graph</span>
</span><span id="GridNetworkSpace-112"><a href="#GridNetworkSpace-112"><span class="linenos">112</span></a>            <span class="n">edge</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">edge_candidates</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_edge_preference</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edge_candidates</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GridNetworkSpace-113"><a href="#GridNetworkSpace-113"><span class="linenos">113</span></a>
</span><span id="GridNetworkSpace-114"><a href="#GridNetworkSpace-114"><span class="linenos">114</span></a>            <span class="c1"># If the sink of the new edge is new in the graph, add edges to its neighbours as new edge candidates</span>
</span><span id="GridNetworkSpace-115"><a href="#GridNetworkSpace-115"><span class="linenos">115</span></a>            <span class="n">node</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GridNetworkSpace-116"><a href="#GridNetworkSpace-116"><span class="linenos">116</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">cnw</span><span class="o">.</span><span class="n">has_node</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
</span><span id="GridNetworkSpace-117"><a href="#GridNetworkSpace-117"><span class="linenos">117</span></a>                <span class="n">edge_candidates</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">node</span><span class="p">,</span> <span class="n">neighbour</span><span class="p">)</span> <span class="k">for</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_neighbours</span><span class="p">(</span><span class="n">node</span><span class="p">)]</span>
</span><span id="GridNetworkSpace-118"><a href="#GridNetworkSpace-118"><span class="linenos">118</span></a>            <span class="c1"># Add the new edge (and implicitly its nodes), and remove the edge as a candidate.</span>
</span><span id="GridNetworkSpace-119"><a href="#GridNetworkSpace-119"><span class="linenos">119</span></a>            <span class="n">cnw</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
</span><span id="GridNetworkSpace-120"><a href="#GridNetworkSpace-120"><span class="linenos">120</span></a>            <span class="n">edge_candidates</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
</span><span id="GridNetworkSpace-121"><a href="#GridNetworkSpace-121"><span class="linenos">121</span></a>
</span><span id="GridNetworkSpace-122"><a href="#GridNetworkSpace-122"><span class="linenos">122</span></a>        <span class="c1"># Step 2. Add lanes and roundabouts.</span>
</span><span id="GridNetworkSpace-123"><a href="#GridNetworkSpace-123"><span class="linenos">123</span></a>        <span class="c1"># Create a new graph, this time directed. Each node in the coarse graph maps to 4 x 4 nodes in the new graph.</span>
</span><span id="GridNetworkSpace-124"><a href="#GridNetworkSpace-124"><span class="linenos">124</span></a>        <span class="n">rnw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">road_network</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
</span><span id="GridNetworkSpace-125"><a href="#GridNetworkSpace-125"><span class="linenos">125</span></a>
</span><span id="GridNetworkSpace-126"><a href="#GridNetworkSpace-126"><span class="linenos">126</span></a>        <span class="c1"># Add internal connections between coarse node in detailed graph.</span>
</span><span id="GridNetworkSpace-127"><a href="#GridNetworkSpace-127"><span class="linenos">127</span></a>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">:</span>
</span><span id="GridNetworkSpace-128"><a href="#GridNetworkSpace-128"><span class="linenos">128</span></a>            <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># East</span>
</span><span id="GridNetworkSpace-129"><a href="#GridNetworkSpace-129"><span class="linenos">129</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;EEE&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace-130"><a href="#GridNetworkSpace-130"><span class="linenos">130</span></a>            <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># West</span>
</span><span id="GridNetworkSpace-131"><a href="#GridNetworkSpace-131"><span class="linenos">131</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;WWW&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace-132"><a href="#GridNetworkSpace-132"><span class="linenos">132</span></a>            <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># North</span>
</span><span id="GridNetworkSpace-133"><a href="#GridNetworkSpace-133"><span class="linenos">133</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;NNN&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace-134"><a href="#GridNetworkSpace-134"><span class="linenos">134</span></a>            <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># South</span>
</span><span id="GridNetworkSpace-135"><a href="#GridNetworkSpace-135"><span class="linenos">135</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;SSS&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace-136"><a href="#GridNetworkSpace-136"><span class="linenos">136</span></a>
</span><span id="GridNetworkSpace-137"><a href="#GridNetworkSpace-137"><span class="linenos">137</span></a>        <span class="c1"># Add connections for roundabouts and through roads</span>
</span><span id="GridNetworkSpace-138"><a href="#GridNetworkSpace-138"><span class="linenos">138</span></a>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">:</span>
</span><span id="GridNetworkSpace-139"><a href="#GridNetworkSpace-139"><span class="linenos">139</span></a>            <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">node</span>
</span><span id="GridNetworkSpace-140"><a href="#GridNetworkSpace-140"><span class="linenos">140</span></a>            <span class="k">if</span> <span class="n">cnw</span><span class="o">.</span><span class="n">degree</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GridNetworkSpace-141"><a href="#GridNetworkSpace-141"><span class="linenos">141</span></a>                <span class="c1"># Dead ends need to make it possible to turn around, which requires adding three out of four edges.</span>
</span><span id="GridNetworkSpace-142"><a href="#GridNetworkSpace-142"><span class="linenos">142</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># No eastern neighbour</span>
</span><span id="GridNetworkSpace-143"><a href="#GridNetworkSpace-143"><span class="linenos">143</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;N&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace-144"><a href="#GridNetworkSpace-144"><span class="linenos">144</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># No western neighbour</span>
</span><span id="GridNetworkSpace-145"><a href="#GridNetworkSpace-145"><span class="linenos">145</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace-146"><a href="#GridNetworkSpace-146"><span class="linenos">146</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># No northern neighbour</span>
</span><span id="GridNetworkSpace-147"><a href="#GridNetworkSpace-147"><span class="linenos">147</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;W&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace-148"><a href="#GridNetworkSpace-148"><span class="linenos">148</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># No southern neighbour</span>
</span><span id="GridNetworkSpace-149"><a href="#GridNetworkSpace-149"><span class="linenos">149</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace-150"><a href="#GridNetworkSpace-150"><span class="linenos">150</span></a>            <span class="k">if</span> <span class="n">cnw</span><span class="o">.</span><span class="n">degree</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="GridNetworkSpace-151"><a href="#GridNetworkSpace-151"><span class="linenos">151</span></a>                <span class="c1"># Through roads</span>
</span><span id="GridNetworkSpace-152"><a href="#GridNetworkSpace-152"><span class="linenos">152</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># Northern and western neighbours</span>
</span><span id="GridNetworkSpace-153"><a href="#GridNetworkSpace-153"><span class="linenos">153</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;EN&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace-154"><a href="#GridNetworkSpace-154"><span class="linenos">154</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># Northern and southern neighbours</span>
</span><span id="GridNetworkSpace-155"><a href="#GridNetworkSpace-155"><span class="linenos">155</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace-156"><a href="#GridNetworkSpace-156"><span class="linenos">156</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;N&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace-157"><a href="#GridNetworkSpace-157"><span class="linenos">157</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># Northern and eastern neighbours</span>
</span><span id="GridNetworkSpace-158"><a href="#GridNetworkSpace-158"><span class="linenos">158</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;SE&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace-159"><a href="#GridNetworkSpace-159"><span class="linenos">159</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># Western and southern neighbours</span>
</span><span id="GridNetworkSpace-160"><a href="#GridNetworkSpace-160"><span class="linenos">160</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;NW&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace-161"><a href="#GridNetworkSpace-161"><span class="linenos">161</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># Western and eastern neighbours</span>
</span><span id="GridNetworkSpace-162"><a href="#GridNetworkSpace-162"><span class="linenos">162</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;W&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace-163"><a href="#GridNetworkSpace-163"><span class="linenos">163</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace-164"><a href="#GridNetworkSpace-164"><span class="linenos">164</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># Southern and eastern neighbours</span>
</span><span id="GridNetworkSpace-165"><a href="#GridNetworkSpace-165"><span class="linenos">165</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;WS&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace-166"><a href="#GridNetworkSpace-166"><span class="linenos">166</span></a>            <span class="k">if</span> <span class="n">cnw</span><span class="o">.</span><span class="n">degree</span><span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="GridNetworkSpace-167"><a href="#GridNetworkSpace-167"><span class="linenos">167</span></a>                <span class="c1"># Three and four way crossings require roundabouts, so all four edges are added.</span>
</span><span id="GridNetworkSpace-168"><a href="#GridNetworkSpace-168"><span class="linenos">168</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;SENW&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace-169"><a href="#GridNetworkSpace-169"><span class="linenos">169</span></a>
</span><span id="GridNetworkSpace-170"><a href="#GridNetworkSpace-170"><span class="linenos">170</span></a>        <span class="c1"># Keep track of all agents in a node</span>
</span><span id="GridNetworkSpace-171"><a href="#GridNetworkSpace-171"><span class="linenos">171</span></a>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">rnw</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
</span><span id="GridNetworkSpace-172"><a href="#GridNetworkSpace-172"><span class="linenos">172</span></a>            <span class="n">rnw</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;agent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GridNetworkSpace-173"><a href="#GridNetworkSpace-173"><span class="linenos">173</span></a>
</span><span id="GridNetworkSpace-174"><a href="#GridNetworkSpace-174"><span class="linenos">174</span></a>    <span class="k">def</span> <span class="nf">add_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">directions</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="GridNetworkSpace-175"><a href="#GridNetworkSpace-175"><span class="linenos">175</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace-176"><a href="#GridNetworkSpace-176"><span class="linenos">176</span></a><span class="sd">        Adds a sequence of edges to the road network, starting in the provided node and going in the provided directions.</span>
</span><span id="GridNetworkSpace-177"><a href="#GridNetworkSpace-177"><span class="linenos">177</span></a>
</span><span id="GridNetworkSpace-178"><a href="#GridNetworkSpace-178"><span class="linenos">178</span></a><span class="sd">        Args:</span>
</span><span id="GridNetworkSpace-179"><a href="#GridNetworkSpace-179"><span class="linenos">179</span></a><span class="sd">            node (Node): the start node.</span>
</span><span id="GridNetworkSpace-180"><a href="#GridNetworkSpace-180"><span class="linenos">180</span></a><span class="sd">            directions (str): the direction, which is a string containing the characters N, E, S, W</span>
</span><span id="GridNetworkSpace-181"><a href="#GridNetworkSpace-181"><span class="linenos">181</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace-182"><a href="#GridNetworkSpace-182"><span class="linenos">182</span></a>        <span class="n">rnw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">road_network</span>
</span><span id="GridNetworkSpace-183"><a href="#GridNetworkSpace-183"><span class="linenos">183</span></a>        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">directions</span><span class="p">:</span>
</span><span id="GridNetworkSpace-184"><a href="#GridNetworkSpace-184"><span class="linenos">184</span></a>            <span class="n">next_node</span> <span class="o">=</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="GridNetworkSpace-185"><a href="#GridNetworkSpace-185"><span class="linenos">185</span></a>            <span class="n">rnw</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">next_node</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="n">d</span><span class="p">)</span>
</span><span id="GridNetworkSpace-186"><a href="#GridNetworkSpace-186"><span class="linenos">186</span></a>            <span class="n">node</span> <span class="o">=</span> <span class="n">next_node</span>
</span><span id="GridNetworkSpace-187"><a href="#GridNetworkSpace-187"><span class="linenos">187</span></a>
</span><span id="GridNetworkSpace-188"><a href="#GridNetworkSpace-188"><span class="linenos">188</span></a>    <span class="k">def</span> <span class="nf">_edge_preference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge</span><span class="p">:</span> <span class="n">Edge</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="GridNetworkSpace-189"><a href="#GridNetworkSpace-189"><span class="linenos">189</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace-190"><a href="#GridNetworkSpace-190"><span class="linenos">190</span></a><span class="sd">        Provides a heuristic for adding edges to the coarse network during generation.</span>
</span><span id="GridNetworkSpace-191"><a href="#GridNetworkSpace-191"><span class="linenos">191</span></a><span class="sd">        It assigns a random preference to the provided edge depending on where it is on the grid and the connecting nodes previous edges.</span>
</span><span id="GridNetworkSpace-192"><a href="#GridNetworkSpace-192"><span class="linenos">192</span></a>
</span><span id="GridNetworkSpace-193"><a href="#GridNetworkSpace-193"><span class="linenos">193</span></a><span class="sd">        Args:</span>
</span><span id="GridNetworkSpace-194"><a href="#GridNetworkSpace-194"><span class="linenos">194</span></a><span class="sd">            edge (Edge): the edge.</span>
</span><span id="GridNetworkSpace-195"><a href="#GridNetworkSpace-195"><span class="linenos">195</span></a>
</span><span id="GridNetworkSpace-196"><a href="#GridNetworkSpace-196"><span class="linenos">196</span></a><span class="sd">        Returns:</span>
</span><span id="GridNetworkSpace-197"><a href="#GridNetworkSpace-197"><span class="linenos">197</span></a><span class="sd">            float: a number indicating how preferred this edge is.</span>
</span><span id="GridNetworkSpace-198"><a href="#GridNetworkSpace-198"><span class="linenos">198</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace-199"><a href="#GridNetworkSpace-199"><span class="linenos">199</span></a>        <span class="c1"># Returns a numerical value indicating how preferred this edge is (higher means more likely to be selected)</span>
</span><span id="GridNetworkSpace-200"><a href="#GridNetworkSpace-200"><span class="linenos">200</span></a>        <span class="n">cnw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_network</span>
</span><span id="GridNetworkSpace-201"><a href="#GridNetworkSpace-201"><span class="linenos">201</span></a>
</span><span id="GridNetworkSpace-202"><a href="#GridNetworkSpace-202"><span class="linenos">202</span></a>        <span class="c1"># Count number of existing edges for the source and sink of the selected edge</span>
</span><span id="GridNetworkSpace-203"><a href="#GridNetworkSpace-203"><span class="linenos">203</span></a>        <span class="n">nb_source_edges</span> <span class="o">=</span> <span class="n">cnw</span><span class="o">.</span><span class="n">degree</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">cnw</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="GridNetworkSpace-204"><a href="#GridNetworkSpace-204"><span class="linenos">204</span></a>        <span class="n">nb_sink_edges</span> <span class="o">=</span> <span class="n">cnw</span><span class="o">.</span><span class="n">degree</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">if</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">cnw</span> <span class="k">else</span> <span class="mi">0</span>
</span><span id="GridNetworkSpace-205"><a href="#GridNetworkSpace-205"><span class="linenos">205</span></a>
</span><span id="GridNetworkSpace-206"><a href="#GridNetworkSpace-206"><span class="linenos">206</span></a>        <span class="c1"># Count distance of sink from center of world normalized with respect to the size of the world</span>
</span><span id="GridNetworkSpace-207"><a href="#GridNetworkSpace-207"><span class="linenos">207</span></a>        <span class="n">dist_x</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_x</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="GridNetworkSpace-208"><a href="#GridNetworkSpace-208"><span class="linenos">208</span></a>        <span class="n">dist_y</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="GridNetworkSpace-209"><a href="#GridNetworkSpace-209"><span class="linenos">209</span></a>        <span class="n">norm_dist</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dist_x</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dist_y</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">size_x</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size_y</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="GridNetworkSpace-210"><a href="#GridNetworkSpace-210"><span class="linenos">210</span></a>
</span><span id="GridNetworkSpace-211"><a href="#GridNetworkSpace-211"><span class="linenos">211</span></a>        <span class="c1"># Prefer adding edges away from the center and adding new nodes (a small epsilon is added to ensure that weights &gt; 0)</span>
</span><span id="GridNetworkSpace-212"><a href="#GridNetworkSpace-212"><span class="linenos">212</span></a>        <span class="k">return</span> <span class="mi">50</span> <span class="o">*</span> <span class="n">norm_dist</span> <span class="o">/</span> <span class="p">(</span><span class="n">nb_source_edges</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">nb_sink_edges</span> <span class="o">+</span> <span class="mf">0.00001</span><span class="p">)</span>
</span><span id="GridNetworkSpace-213"><a href="#GridNetworkSpace-213"><span class="linenos">213</span></a>        
</span><span id="GridNetworkSpace-214"><a href="#GridNetworkSpace-214"><span class="linenos">214</span></a>    <span class="k">def</span> <span class="nf">grid_neighbours</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]:</span>
</span><span id="GridNetworkSpace-215"><a href="#GridNetworkSpace-215"><span class="linenos">215</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace-216"><a href="#GridNetworkSpace-216"><span class="linenos">216</span></a><span class="sd">        Returns the grid neighbours of a node, taking coarse network grid boundaries into accound.</span>
</span><span id="GridNetworkSpace-217"><a href="#GridNetworkSpace-217"><span class="linenos">217</span></a><span class="sd">        Diagonal neighbours are not considered.</span>
</span><span id="GridNetworkSpace-218"><a href="#GridNetworkSpace-218"><span class="linenos">218</span></a>
</span><span id="GridNetworkSpace-219"><a href="#GridNetworkSpace-219"><span class="linenos">219</span></a><span class="sd">        Args:</span>
</span><span id="GridNetworkSpace-220"><a href="#GridNetworkSpace-220"><span class="linenos">220</span></a><span class="sd">            node (Node): the node.</span>
</span><span id="GridNetworkSpace-221"><a href="#GridNetworkSpace-221"><span class="linenos">221</span></a>
</span><span id="GridNetworkSpace-222"><a href="#GridNetworkSpace-222"><span class="linenos">222</span></a><span class="sd">        Returns:</span>
</span><span id="GridNetworkSpace-223"><a href="#GridNetworkSpace-223"><span class="linenos">223</span></a><span class="sd">            List[Node]: the neighbours.</span>
</span><span id="GridNetworkSpace-224"><a href="#GridNetworkSpace-224"><span class="linenos">224</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace-225"><a href="#GridNetworkSpace-225"><span class="linenos">225</span></a>        <span class="k">return</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="s2">&quot;EWSN&quot;</span><span class="p">]</span> 
</span><span id="GridNetworkSpace-226"><a href="#GridNetworkSpace-226"><span class="linenos">226</span></a>                <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_x</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span><span class="p">]</span>
</span><span id="GridNetworkSpace-227"><a href="#GridNetworkSpace-227"><span class="linenos">227</span></a>
</span><span id="GridNetworkSpace-228"><a href="#GridNetworkSpace-228"><span class="linenos">228</span></a>    <span class="k">def</span> <span class="nf">generate_destinations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probability</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
</span><span id="GridNetworkSpace-229"><a href="#GridNetworkSpace-229"><span class="linenos">229</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace-230"><a href="#GridNetworkSpace-230"><span class="linenos">230</span></a><span class="sd">        Determines which nodes in the road network should be destinations.</span>
</span><span id="GridNetworkSpace-231"><a href="#GridNetworkSpace-231"><span class="linenos">231</span></a><span class="sd">        Only nodes with exactly one ingoing and one outgoing edge can be a destination.</span>
</span><span id="GridNetworkSpace-232"><a href="#GridNetworkSpace-232"><span class="linenos">232</span></a><span class="sd">        This is to disallow destinations in crossings.</span>
</span><span id="GridNetworkSpace-233"><a href="#GridNetworkSpace-233"><span class="linenos">233</span></a><span class="sd">        </span>
</span><span id="GridNetworkSpace-234"><a href="#GridNetworkSpace-234"><span class="linenos">234</span></a><span class="sd">        Args:</span>
</span><span id="GridNetworkSpace-235"><a href="#GridNetworkSpace-235"><span class="linenos">235</span></a><span class="sd">            probability (float, optional): The probability that an eligible node will be selected as a destination. Defaults to 1.</span>
</span><span id="GridNetworkSpace-236"><a href="#GridNetworkSpace-236"><span class="linenos">236</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace-237"><a href="#GridNetworkSpace-237"><span class="linenos">237</span></a>        <span class="c1"># TODO: This requires some polishing.</span>
</span><span id="GridNetworkSpace-238"><a href="#GridNetworkSpace-238"><span class="linenos">238</span></a>        <span class="n">rnw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">road_network</span>
</span><span id="GridNetworkSpace-239"><a href="#GridNetworkSpace-239"><span class="linenos">239</span></a>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">rnw</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
</span><span id="GridNetworkSpace-240"><a href="#GridNetworkSpace-240"><span class="linenos">240</span></a>            <span class="k">if</span> <span class="n">rnw</span><span class="o">.</span><span class="n">in_degree</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">rnw</span><span class="o">.</span><span class="n">out_degree</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">probability</span><span class="p">:</span>
</span><span id="GridNetworkSpace-241"><a href="#GridNetworkSpace-241"><span class="linenos">241</span></a>                <span class="n">rnw</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;destination&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="GridNetworkSpace-242"><a href="#GridNetworkSpace-242"><span class="linenos">242</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="GridNetworkSpace-243"><a href="#GridNetworkSpace-243"><span class="linenos">243</span></a>                <span class="n">rnw</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;destination&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="GridNetworkSpace-244"><a href="#GridNetworkSpace-244"><span class="linenos">244</span></a>
</span><span id="GridNetworkSpace-245"><a href="#GridNetworkSpace-245"><span class="linenos">245</span></a>    <span class="k">def</span> <span class="nf">priority_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">to_node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]:</span>
</span><span id="GridNetworkSpace-246"><a href="#GridNetworkSpace-246"><span class="linenos">246</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace-247"><a href="#GridNetworkSpace-247"><span class="linenos">247</span></a><span class="sd">        Returns the nodes from which traffic has priority over from_node when going into to_node.</span>
</span><span id="GridNetworkSpace-248"><a href="#GridNetworkSpace-248"><span class="linenos">248</span></a>
</span><span id="GridNetworkSpace-249"><a href="#GridNetworkSpace-249"><span class="linenos">249</span></a><span class="sd">        Args:</span>
</span><span id="GridNetworkSpace-250"><a href="#GridNetworkSpace-250"><span class="linenos">250</span></a><span class="sd">            from_node (Node): the node to be checked for priority.</span>
</span><span id="GridNetworkSpace-251"><a href="#GridNetworkSpace-251"><span class="linenos">251</span></a><span class="sd">            to_node (Node): the node to be checked for priority.</span>
</span><span id="GridNetworkSpace-252"><a href="#GridNetworkSpace-252"><span class="linenos">252</span></a>
</span><span id="GridNetworkSpace-253"><a href="#GridNetworkSpace-253"><span class="linenos">253</span></a><span class="sd">        Returns:</span>
</span><span id="GridNetworkSpace-254"><a href="#GridNetworkSpace-254"><span class="linenos">254</span></a><span class="sd">            List[Node]: a list of nodes from which vehicles have priority.</span>
</span><span id="GridNetworkSpace-255"><a href="#GridNetworkSpace-255"><span class="linenos">255</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace-256"><a href="#GridNetworkSpace-256"><span class="linenos">256</span></a>        <span class="c1"># In a roundabout, W has priority over S, S over E, E over N and N over W.</span>
</span><span id="GridNetworkSpace-257"><a href="#GridNetworkSpace-257"><span class="linenos">257</span></a>        <span class="n">priority_rule</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;W&quot;</span> <span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span> <span class="p">:</span> <span class="s2">&quot;E&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span> <span class="p">:</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span> <span class="p">:</span> <span class="s2">&quot;W&quot;</span> <span class="p">}</span>
</span><span id="GridNetworkSpace-258"><a href="#GridNetworkSpace-258"><span class="linenos">258</span></a>
</span><span id="GridNetworkSpace-259"><a href="#GridNetworkSpace-259"><span class="linenos">259</span></a>        <span class="c1"># Determine which node has priority entering to_node.</span>
</span><span id="GridNetworkSpace-260"><a href="#GridNetworkSpace-260"><span class="linenos">260</span></a>        <span class="n">priority_direction</span> <span class="o">=</span> <span class="n">priority_rule</span><span class="p">[</span><span class="n">direction</span><span class="p">(</span><span class="n">from_node</span><span class="p">,</span> <span class="n">to_node</span><span class="p">)]</span>
</span><span id="GridNetworkSpace-261"><a href="#GridNetworkSpace-261"><span class="linenos">261</span></a>        <span class="n">priority_node</span> <span class="o">=</span> <span class="n">node_to</span><span class="p">(</span><span class="n">to_node</span><span class="p">,</span> <span class="n">priority_direction</span><span class="p">)</span>
</span><span id="GridNetworkSpace-262"><a href="#GridNetworkSpace-262"><span class="linenos">262</span></a>
</span><span id="GridNetworkSpace-263"><a href="#GridNetworkSpace-263"><span class="linenos">263</span></a>        <span class="c1"># If the priority node can reach to_node, return it, otherwise return nothing.</span>
</span><span id="GridNetworkSpace-264"><a href="#GridNetworkSpace-264"><span class="linenos">264</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">road_network</span><span class="o">.</span><span class="n">has_edge</span><span class="p">(</span><span class="n">priority_node</span><span class="p">,</span> <span class="n">to_node</span><span class="p">):</span>
</span><span id="GridNetworkSpace-265"><a href="#GridNetworkSpace-265"><span class="linenos">265</span></a>            <span class="k">return</span> <span class="p">[</span><span class="n">priority_node</span><span class="p">]</span>
</span><span id="GridNetworkSpace-266"><a href="#GridNetworkSpace-266"><span class="linenos">266</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="GridNetworkSpace-267"><a href="#GridNetworkSpace-267"><span class="linenos">267</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span></pre></div>


            <div class="docstring"><p>A mesa space consisting of a road network which is placed on a grid.
The road network is a networkx graph, where node names are tuples (x, y) referring to grid positions.
Some nodes in the road networks can be destinations, where places of interest can be placed.</p>
</div>


                            <div id="GridNetworkSpace.__init__" class="classattr">
                                        <input id="GridNetworkSpace.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">GridNetworkSpace</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>, </span><span class="param"><span class="n">y</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>, </span><span class="param"><span class="n">road_density</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span></span>)</span>

                <label class="view-source-button" for="GridNetworkSpace.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GridNetworkSpace.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GridNetworkSpace.__init__-72"><a href="#GridNetworkSpace.__init__-72"><span class="linenos">72</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">road_density</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">):</span>
</span><span id="GridNetworkSpace.__init__-73"><a href="#GridNetworkSpace.__init__-73"><span class="linenos">73</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace.__init__-74"><a href="#GridNetworkSpace.__init__-74"><span class="linenos">74</span></a><span class="sd">        Creates a grid of size (x, y), and adds a road network to it.</span>
</span><span id="GridNetworkSpace.__init__-75"><a href="#GridNetworkSpace.__init__-75"><span class="linenos">75</span></a><span class="sd">        </span>
</span><span id="GridNetworkSpace.__init__-76"><a href="#GridNetworkSpace.__init__-76"><span class="linenos">76</span></a><span class="sd">        Args:</span>
</span><span id="GridNetworkSpace.__init__-77"><a href="#GridNetworkSpace.__init__-77"><span class="linenos">77</span></a><span class="sd">            x (int, optional): the grid size in the x dimension. Defaults to 10.</span>
</span><span id="GridNetworkSpace.__init__-78"><a href="#GridNetworkSpace.__init__-78"><span class="linenos">78</span></a><span class="sd">            y (int, optional): the grid size in the y dimension. Defaults to 10.</span>
</span><span id="GridNetworkSpace.__init__-79"><a href="#GridNetworkSpace.__init__-79"><span class="linenos">79</span></a><span class="sd">            road_density (float, optional): the proportion of grid elements to be connected by roads. Defaults to 0.3.</span>
</span><span id="GridNetworkSpace.__init__-80"><a href="#GridNetworkSpace.__init__-80"><span class="linenos">80</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace.__init__-81"><a href="#GridNetworkSpace.__init__-81"><span class="linenos">81</span></a>        <span class="c1"># Setup parameters</span>
</span><span id="GridNetworkSpace.__init__-82"><a href="#GridNetworkSpace.__init__-82"><span class="linenos">82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size_x</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="GridNetworkSpace.__init__-83"><a href="#GridNetworkSpace.__init__-83"><span class="linenos">83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span> <span class="o">=</span> <span class="n">y</span>
</span><span id="GridNetworkSpace.__init__-84"><a href="#GridNetworkSpace.__init__-84"><span class="linenos">84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">road_density</span> <span class="o">=</span> <span class="n">road_density</span>
</span><span id="GridNetworkSpace.__init__-85"><a href="#GridNetworkSpace.__init__-85"><span class="linenos">85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">coarse_network</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GridNetworkSpace.__init__-86"><a href="#GridNetworkSpace.__init__-86"><span class="linenos">86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">road_network</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GridNetworkSpace.__init__-87"><a href="#GridNetworkSpace.__init__-87"><span class="linenos">87</span></a>
</span><span id="GridNetworkSpace.__init__-88"><a href="#GridNetworkSpace.__init__-88"><span class="linenos">88</span></a>        <span class="c1"># Generate roads and destinations</span>
</span><span id="GridNetworkSpace.__init__-89"><a href="#GridNetworkSpace.__init__-89"><span class="linenos">89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_roads</span><span class="p">()</span>
</span><span id="GridNetworkSpace.__init__-90"><a href="#GridNetworkSpace.__init__-90"><span class="linenos">90</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">generate_destinations</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Creates a grid of size (x, y), and adds a road network to it.</p>

<p>Args:
    x (int, optional): the grid size in the x dimension. Defaults to 10.
    y (int, optional): the grid size in the y dimension. Defaults to 10.
    road_density (float, optional): the proportion of grid elements to be connected by roads. Defaults to 0.3.</p>
</div>


                            </div>
                            <div id="GridNetworkSpace.size_x" class="classattr">
                                <div class="attr variable">
            <span class="name">size_x</span>

        
    </div>
    <a class="headerlink" href="#GridNetworkSpace.size_x"></a>
    
    

                            </div>
                            <div id="GridNetworkSpace.size_y" class="classattr">
                                <div class="attr variable">
            <span class="name">size_y</span>

        
    </div>
    <a class="headerlink" href="#GridNetworkSpace.size_y"></a>
    
    

                            </div>
                            <div id="GridNetworkSpace.road_density" class="classattr">
                                <div class="attr variable">
            <span class="name">road_density</span>

        
    </div>
    <a class="headerlink" href="#GridNetworkSpace.road_density"></a>
    
    

                            </div>
                            <div id="GridNetworkSpace.coarse_network" class="classattr">
                                <div class="attr variable">
            <span class="name">coarse_network</span>

        
    </div>
    <a class="headerlink" href="#GridNetworkSpace.coarse_network"></a>
    
    

                            </div>
                            <div id="GridNetworkSpace.road_network" class="classattr">
                                <div class="attr variable">
            <span class="name">road_network</span>

        
    </div>
    <a class="headerlink" href="#GridNetworkSpace.road_network"></a>
    
    

                            </div>
                            <div id="GridNetworkSpace.generate_roads" class="classattr">
                                        <input id="GridNetworkSpace.generate_roads-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_roads</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GridNetworkSpace.generate_roads-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GridNetworkSpace.generate_roads"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GridNetworkSpace.generate_roads-92"><a href="#GridNetworkSpace.generate_roads-92"><span class="linenos"> 92</span></a>    <span class="k">def</span> <span class="nf">generate_roads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="GridNetworkSpace.generate_roads-93"><a href="#GridNetworkSpace.generate_roads-93"><span class="linenos"> 93</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace.generate_roads-94"><a href="#GridNetworkSpace.generate_roads-94"><span class="linenos"> 94</span></a><span class="sd">        Generates the road network. This is a two step process.</span>
</span><span id="GridNetworkSpace.generate_roads-95"><a href="#GridNetworkSpace.generate_roads-95"><span class="linenos"> 95</span></a><span class="sd">        First, a coarse undirected network is generated, where each node corresponds to a grid cell.</span>
</span><span id="GridNetworkSpace.generate_roads-96"><a href="#GridNetworkSpace.generate_roads-96"><span class="linenos"> 96</span></a><span class="sd">        Heustistics are used to try to spread this network over the grid and have a balance between dense and sprawling roads.</span>
</span><span id="GridNetworkSpace.generate_roads-97"><a href="#GridNetworkSpace.generate_roads-97"><span class="linenos"> 97</span></a><span class="sd">        Second, this network is expanded into a directed graph, containing separate roadways and roundabouts.</span>
</span><span id="GridNetworkSpace.generate_roads-98"><a href="#GridNetworkSpace.generate_roads-98"><span class="linenos"> 98</span></a><span class="sd">        This is achieved by dividing each coarse network node / grid cell into 4 x 4 subnodes.</span>
</span><span id="GridNetworkSpace.generate_roads-99"><a href="#GridNetworkSpace.generate_roads-99"><span class="linenos"> 99</span></a><span class="sd">        These are connected so that traffic in all directions become possible.</span>
</span><span id="GridNetworkSpace.generate_roads-100"><a href="#GridNetworkSpace.generate_roads-100"><span class="linenos">100</span></a><span class="sd">        In the resulting directed network, each node has either one or two outgoing edges.</span>
</span><span id="GridNetworkSpace.generate_roads-101"><a href="#GridNetworkSpace.generate_roads-101"><span class="linenos">101</span></a><span class="sd">        The network keeps track of what agents are currently in a node.</span>
</span><span id="GridNetworkSpace.generate_roads-102"><a href="#GridNetworkSpace.generate_roads-102"><span class="linenos">102</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace.generate_roads-103"><a href="#GridNetworkSpace.generate_roads-103"><span class="linenos">103</span></a>        <span class="n">cnw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coarse_network</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
</span><span id="GridNetworkSpace.generate_roads-104"><a href="#GridNetworkSpace.generate_roads-104"><span class="linenos">104</span></a>
</span><span id="GridNetworkSpace.generate_roads-105"><a href="#GridNetworkSpace.generate_roads-105"><span class="linenos">105</span></a>        <span class="c1"># Step 1. Create a connected graph whose nodes are a subset of the grid cells.</span>
</span><span id="GridNetworkSpace.generate_roads-106"><a href="#GridNetworkSpace.generate_roads-106"><span class="linenos">106</span></a>        <span class="n">node</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size_x</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span> <span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</span><span id="GridNetworkSpace.generate_roads-107"><a href="#GridNetworkSpace.generate_roads-107"><span class="linenos">107</span></a>        <span class="n">edge_candidates</span> <span class="o">=</span> <span class="p">[(</span><span class="n">node</span><span class="p">,</span> <span class="n">neighbour</span><span class="p">)</span> <span class="k">for</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_neighbours</span><span class="p">(</span><span class="n">node</span><span class="p">)]</span>
</span><span id="GridNetworkSpace.generate_roads-108"><a href="#GridNetworkSpace.generate_roads-108"><span class="linenos">108</span></a>
</span><span id="GridNetworkSpace.generate_roads-109"><a href="#GridNetworkSpace.generate_roads-109"><span class="linenos">109</span></a>        <span class="c1"># The number of nodes is determined by the road_density parameter.</span>
</span><span id="GridNetworkSpace.generate_roads-110"><a href="#GridNetworkSpace.generate_roads-110"><span class="linenos">110</span></a>        <span class="k">while</span> <span class="n">nx</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">(</span><span class="n">cnw</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_x</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">road_density</span><span class="p">:</span>
</span><span id="GridNetworkSpace.generate_roads-111"><a href="#GridNetworkSpace.generate_roads-111"><span class="linenos">111</span></a>            <span class="c1"># Pick an edge to add, removing it from the candidates and adding it to the graph</span>
</span><span id="GridNetworkSpace.generate_roads-112"><a href="#GridNetworkSpace.generate_roads-112"><span class="linenos">112</span></a>            <span class="n">edge</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">edge_candidates</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_edge_preference</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edge_candidates</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GridNetworkSpace.generate_roads-113"><a href="#GridNetworkSpace.generate_roads-113"><span class="linenos">113</span></a>
</span><span id="GridNetworkSpace.generate_roads-114"><a href="#GridNetworkSpace.generate_roads-114"><span class="linenos">114</span></a>            <span class="c1"># If the sink of the new edge is new in the graph, add edges to its neighbours as new edge candidates</span>
</span><span id="GridNetworkSpace.generate_roads-115"><a href="#GridNetworkSpace.generate_roads-115"><span class="linenos">115</span></a>            <span class="n">node</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GridNetworkSpace.generate_roads-116"><a href="#GridNetworkSpace.generate_roads-116"><span class="linenos">116</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">cnw</span><span class="o">.</span><span class="n">has_node</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
</span><span id="GridNetworkSpace.generate_roads-117"><a href="#GridNetworkSpace.generate_roads-117"><span class="linenos">117</span></a>                <span class="n">edge_candidates</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">node</span><span class="p">,</span> <span class="n">neighbour</span><span class="p">)</span> <span class="k">for</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_neighbours</span><span class="p">(</span><span class="n">node</span><span class="p">)]</span>
</span><span id="GridNetworkSpace.generate_roads-118"><a href="#GridNetworkSpace.generate_roads-118"><span class="linenos">118</span></a>            <span class="c1"># Add the new edge (and implicitly its nodes), and remove the edge as a candidate.</span>
</span><span id="GridNetworkSpace.generate_roads-119"><a href="#GridNetworkSpace.generate_roads-119"><span class="linenos">119</span></a>            <span class="n">cnw</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">edge</span><span class="p">)</span>
</span><span id="GridNetworkSpace.generate_roads-120"><a href="#GridNetworkSpace.generate_roads-120"><span class="linenos">120</span></a>            <span class="n">edge_candidates</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>
</span><span id="GridNetworkSpace.generate_roads-121"><a href="#GridNetworkSpace.generate_roads-121"><span class="linenos">121</span></a>
</span><span id="GridNetworkSpace.generate_roads-122"><a href="#GridNetworkSpace.generate_roads-122"><span class="linenos">122</span></a>        <span class="c1"># Step 2. Add lanes and roundabouts.</span>
</span><span id="GridNetworkSpace.generate_roads-123"><a href="#GridNetworkSpace.generate_roads-123"><span class="linenos">123</span></a>        <span class="c1"># Create a new graph, this time directed. Each node in the coarse graph maps to 4 x 4 nodes in the new graph.</span>
</span><span id="GridNetworkSpace.generate_roads-124"><a href="#GridNetworkSpace.generate_roads-124"><span class="linenos">124</span></a>        <span class="n">rnw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">road_network</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
</span><span id="GridNetworkSpace.generate_roads-125"><a href="#GridNetworkSpace.generate_roads-125"><span class="linenos">125</span></a>
</span><span id="GridNetworkSpace.generate_roads-126"><a href="#GridNetworkSpace.generate_roads-126"><span class="linenos">126</span></a>        <span class="c1"># Add internal connections between coarse node in detailed graph.</span>
</span><span id="GridNetworkSpace.generate_roads-127"><a href="#GridNetworkSpace.generate_roads-127"><span class="linenos">127</span></a>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">:</span>
</span><span id="GridNetworkSpace.generate_roads-128"><a href="#GridNetworkSpace.generate_roads-128"><span class="linenos">128</span></a>            <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># East</span>
</span><span id="GridNetworkSpace.generate_roads-129"><a href="#GridNetworkSpace.generate_roads-129"><span class="linenos">129</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;EEE&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace.generate_roads-130"><a href="#GridNetworkSpace.generate_roads-130"><span class="linenos">130</span></a>            <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># West</span>
</span><span id="GridNetworkSpace.generate_roads-131"><a href="#GridNetworkSpace.generate_roads-131"><span class="linenos">131</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;WWW&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace.generate_roads-132"><a href="#GridNetworkSpace.generate_roads-132"><span class="linenos">132</span></a>            <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># North</span>
</span><span id="GridNetworkSpace.generate_roads-133"><a href="#GridNetworkSpace.generate_roads-133"><span class="linenos">133</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;NNN&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace.generate_roads-134"><a href="#GridNetworkSpace.generate_roads-134"><span class="linenos">134</span></a>            <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># South</span>
</span><span id="GridNetworkSpace.generate_roads-135"><a href="#GridNetworkSpace.generate_roads-135"><span class="linenos">135</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;SSS&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace.generate_roads-136"><a href="#GridNetworkSpace.generate_roads-136"><span class="linenos">136</span></a>
</span><span id="GridNetworkSpace.generate_roads-137"><a href="#GridNetworkSpace.generate_roads-137"><span class="linenos">137</span></a>        <span class="c1"># Add connections for roundabouts and through roads</span>
</span><span id="GridNetworkSpace.generate_roads-138"><a href="#GridNetworkSpace.generate_roads-138"><span class="linenos">138</span></a>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">:</span>
</span><span id="GridNetworkSpace.generate_roads-139"><a href="#GridNetworkSpace.generate_roads-139"><span class="linenos">139</span></a>            <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="n">node</span>
</span><span id="GridNetworkSpace.generate_roads-140"><a href="#GridNetworkSpace.generate_roads-140"><span class="linenos">140</span></a>            <span class="k">if</span> <span class="n">cnw</span><span class="o">.</span><span class="n">degree</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GridNetworkSpace.generate_roads-141"><a href="#GridNetworkSpace.generate_roads-141"><span class="linenos">141</span></a>                <span class="c1"># Dead ends need to make it possible to turn around, which requires adding three out of four edges.</span>
</span><span id="GridNetworkSpace.generate_roads-142"><a href="#GridNetworkSpace.generate_roads-142"><span class="linenos">142</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># No eastern neighbour</span>
</span><span id="GridNetworkSpace.generate_roads-143"><a href="#GridNetworkSpace.generate_roads-143"><span class="linenos">143</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;N&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace.generate_roads-144"><a href="#GridNetworkSpace.generate_roads-144"><span class="linenos">144</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># No western neighbour</span>
</span><span id="GridNetworkSpace.generate_roads-145"><a href="#GridNetworkSpace.generate_roads-145"><span class="linenos">145</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace.generate_roads-146"><a href="#GridNetworkSpace.generate_roads-146"><span class="linenos">146</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># No northern neighbour</span>
</span><span id="GridNetworkSpace.generate_roads-147"><a href="#GridNetworkSpace.generate_roads-147"><span class="linenos">147</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;W&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace.generate_roads-148"><a href="#GridNetworkSpace.generate_roads-148"><span class="linenos">148</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># No southern neighbour</span>
</span><span id="GridNetworkSpace.generate_roads-149"><a href="#GridNetworkSpace.generate_roads-149"><span class="linenos">149</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace.generate_roads-150"><a href="#GridNetworkSpace.generate_roads-150"><span class="linenos">150</span></a>            <span class="k">if</span> <span class="n">cnw</span><span class="o">.</span><span class="n">degree</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="GridNetworkSpace.generate_roads-151"><a href="#GridNetworkSpace.generate_roads-151"><span class="linenos">151</span></a>                <span class="c1"># Through roads</span>
</span><span id="GridNetworkSpace.generate_roads-152"><a href="#GridNetworkSpace.generate_roads-152"><span class="linenos">152</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># Northern and western neighbours</span>
</span><span id="GridNetworkSpace.generate_roads-153"><a href="#GridNetworkSpace.generate_roads-153"><span class="linenos">153</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;EN&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace.generate_roads-154"><a href="#GridNetworkSpace.generate_roads-154"><span class="linenos">154</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># Northern and southern neighbours</span>
</span><span id="GridNetworkSpace.generate_roads-155"><a href="#GridNetworkSpace.generate_roads-155"><span class="linenos">155</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace.generate_roads-156"><a href="#GridNetworkSpace.generate_roads-156"><span class="linenos">156</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;N&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace.generate_roads-157"><a href="#GridNetworkSpace.generate_roads-157"><span class="linenos">157</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># Northern and eastern neighbours</span>
</span><span id="GridNetworkSpace.generate_roads-158"><a href="#GridNetworkSpace.generate_roads-158"><span class="linenos">158</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;SE&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace.generate_roads-159"><a href="#GridNetworkSpace.generate_roads-159"><span class="linenos">159</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># Western and southern neighbours</span>
</span><span id="GridNetworkSpace.generate_roads-160"><a href="#GridNetworkSpace.generate_roads-160"><span class="linenos">160</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;NW&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace.generate_roads-161"><a href="#GridNetworkSpace.generate_roads-161"><span class="linenos">161</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># Western and eastern neighbours</span>
</span><span id="GridNetworkSpace.generate_roads-162"><a href="#GridNetworkSpace.generate_roads-162"><span class="linenos">162</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;W&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace.generate_roads-163"><a href="#GridNetworkSpace.generate_roads-163"><span class="linenos">163</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace.generate_roads-164"><a href="#GridNetworkSpace.generate_roads-164"><span class="linenos">164</span></a>                <span class="k">if</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="ow">and</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cnw</span><span class="p">[</span><span class="n">node</span><span class="p">]:</span> <span class="c1"># Southern and eastern neighbours</span>
</span><span id="GridNetworkSpace.generate_roads-165"><a href="#GridNetworkSpace.generate_roads-165"><span class="linenos">165</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;WS&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace.generate_roads-166"><a href="#GridNetworkSpace.generate_roads-166"><span class="linenos">166</span></a>            <span class="k">if</span> <span class="n">cnw</span><span class="o">.</span><span class="n">degree</span><span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="GridNetworkSpace.generate_roads-167"><a href="#GridNetworkSpace.generate_roads-167"><span class="linenos">167</span></a>                <span class="c1"># Three and four way crossings require roundabouts, so all four edges are added.</span>
</span><span id="GridNetworkSpace.generate_roads-168"><a href="#GridNetworkSpace.generate_roads-168"><span class="linenos">168</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">(</span><span class="n">subnode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;SENW&quot;</span><span class="p">)</span>
</span><span id="GridNetworkSpace.generate_roads-169"><a href="#GridNetworkSpace.generate_roads-169"><span class="linenos">169</span></a>
</span><span id="GridNetworkSpace.generate_roads-170"><a href="#GridNetworkSpace.generate_roads-170"><span class="linenos">170</span></a>        <span class="c1"># Keep track of all agents in a node</span>
</span><span id="GridNetworkSpace.generate_roads-171"><a href="#GridNetworkSpace.generate_roads-171"><span class="linenos">171</span></a>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">rnw</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
</span><span id="GridNetworkSpace.generate_roads-172"><a href="#GridNetworkSpace.generate_roads-172"><span class="linenos">172</span></a>            <span class="n">rnw</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;agent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span></pre></div>


            <div class="docstring"><p>Generates the road network. This is a two step process.
First, a coarse undirected network is generated, where each node corresponds to a grid cell.
Heustistics are used to try to spread this network over the grid and have a balance between dense and sprawling roads.
Second, this network is expanded into a directed graph, containing separate roadways and roundabouts.
This is achieved by dividing each coarse network node / grid cell into 4 x 4 subnodes.
These are connected so that traffic in all directions become possible.
In the resulting directed network, each node has either one or two outgoing edges.
The network keeps track of what agents are currently in a node.</p>
</div>


                            </div>
                            <div id="GridNetworkSpace.add_edges" class="classattr">
                                        <input id="GridNetworkSpace.add_edges-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_edges</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">node</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>, </span><span class="param"><span class="n">directions</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GridNetworkSpace.add_edges-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GridNetworkSpace.add_edges"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GridNetworkSpace.add_edges-174"><a href="#GridNetworkSpace.add_edges-174"><span class="linenos">174</span></a>    <span class="k">def</span> <span class="nf">add_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">directions</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="GridNetworkSpace.add_edges-175"><a href="#GridNetworkSpace.add_edges-175"><span class="linenos">175</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace.add_edges-176"><a href="#GridNetworkSpace.add_edges-176"><span class="linenos">176</span></a><span class="sd">        Adds a sequence of edges to the road network, starting in the provided node and going in the provided directions.</span>
</span><span id="GridNetworkSpace.add_edges-177"><a href="#GridNetworkSpace.add_edges-177"><span class="linenos">177</span></a>
</span><span id="GridNetworkSpace.add_edges-178"><a href="#GridNetworkSpace.add_edges-178"><span class="linenos">178</span></a><span class="sd">        Args:</span>
</span><span id="GridNetworkSpace.add_edges-179"><a href="#GridNetworkSpace.add_edges-179"><span class="linenos">179</span></a><span class="sd">            node (Node): the start node.</span>
</span><span id="GridNetworkSpace.add_edges-180"><a href="#GridNetworkSpace.add_edges-180"><span class="linenos">180</span></a><span class="sd">            directions (str): the direction, which is a string containing the characters N, E, S, W</span>
</span><span id="GridNetworkSpace.add_edges-181"><a href="#GridNetworkSpace.add_edges-181"><span class="linenos">181</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace.add_edges-182"><a href="#GridNetworkSpace.add_edges-182"><span class="linenos">182</span></a>        <span class="n">rnw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">road_network</span>
</span><span id="GridNetworkSpace.add_edges-183"><a href="#GridNetworkSpace.add_edges-183"><span class="linenos">183</span></a>        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">directions</span><span class="p">:</span>
</span><span id="GridNetworkSpace.add_edges-184"><a href="#GridNetworkSpace.add_edges-184"><span class="linenos">184</span></a>            <span class="n">next_node</span> <span class="o">=</span> <span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="GridNetworkSpace.add_edges-185"><a href="#GridNetworkSpace.add_edges-185"><span class="linenos">185</span></a>            <span class="n">rnw</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">next_node</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="n">d</span><span class="p">)</span>
</span><span id="GridNetworkSpace.add_edges-186"><a href="#GridNetworkSpace.add_edges-186"><span class="linenos">186</span></a>            <span class="n">node</span> <span class="o">=</span> <span class="n">next_node</span>
</span></pre></div>


            <div class="docstring"><p>Adds a sequence of edges to the road network, starting in the provided node and going in the provided directions.</p>

<p>Args:
    node (Node): the start node.
    directions (str): the direction, which is a string containing the characters N, E, S, W</p>
</div>


                            </div>
                            <div id="GridNetworkSpace.grid_neighbours" class="classattr">
                                        <input id="GridNetworkSpace.grid_neighbours-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">grid_neighbours</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">node</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="GridNetworkSpace.grid_neighbours-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GridNetworkSpace.grid_neighbours"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GridNetworkSpace.grid_neighbours-214"><a href="#GridNetworkSpace.grid_neighbours-214"><span class="linenos">214</span></a>    <span class="k">def</span> <span class="nf">grid_neighbours</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]:</span>
</span><span id="GridNetworkSpace.grid_neighbours-215"><a href="#GridNetworkSpace.grid_neighbours-215"><span class="linenos">215</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace.grid_neighbours-216"><a href="#GridNetworkSpace.grid_neighbours-216"><span class="linenos">216</span></a><span class="sd">        Returns the grid neighbours of a node, taking coarse network grid boundaries into accound.</span>
</span><span id="GridNetworkSpace.grid_neighbours-217"><a href="#GridNetworkSpace.grid_neighbours-217"><span class="linenos">217</span></a><span class="sd">        Diagonal neighbours are not considered.</span>
</span><span id="GridNetworkSpace.grid_neighbours-218"><a href="#GridNetworkSpace.grid_neighbours-218"><span class="linenos">218</span></a>
</span><span id="GridNetworkSpace.grid_neighbours-219"><a href="#GridNetworkSpace.grid_neighbours-219"><span class="linenos">219</span></a><span class="sd">        Args:</span>
</span><span id="GridNetworkSpace.grid_neighbours-220"><a href="#GridNetworkSpace.grid_neighbours-220"><span class="linenos">220</span></a><span class="sd">            node (Node): the node.</span>
</span><span id="GridNetworkSpace.grid_neighbours-221"><a href="#GridNetworkSpace.grid_neighbours-221"><span class="linenos">221</span></a>
</span><span id="GridNetworkSpace.grid_neighbours-222"><a href="#GridNetworkSpace.grid_neighbours-222"><span class="linenos">222</span></a><span class="sd">        Returns:</span>
</span><span id="GridNetworkSpace.grid_neighbours-223"><a href="#GridNetworkSpace.grid_neighbours-223"><span class="linenos">223</span></a><span class="sd">            List[Node]: the neighbours.</span>
</span><span id="GridNetworkSpace.grid_neighbours-224"><a href="#GridNetworkSpace.grid_neighbours-224"><span class="linenos">224</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace.grid_neighbours-225"><a href="#GridNetworkSpace.grid_neighbours-225"><span class="linenos">225</span></a>        <span class="k">return</span> <span class="p">[(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">node_to</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="s2">&quot;EWSN&quot;</span><span class="p">]</span> 
</span><span id="GridNetworkSpace.grid_neighbours-226"><a href="#GridNetworkSpace.grid_neighbours-226"><span class="linenos">226</span></a>                <span class="k">if</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_x</span> <span class="ow">and</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">size_y</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Returns the grid neighbours of a node, taking coarse network grid boundaries into accound.
Diagonal neighbours are not considered.</p>

<p>Args:
    node (Node): the node.</p>

<p>Returns:
    List[Node]: the neighbours.</p>
</div>


                            </div>
                            <div id="GridNetworkSpace.generate_destinations" class="classattr">
                                        <input id="GridNetworkSpace.generate_destinations-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_destinations</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">probability</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GridNetworkSpace.generate_destinations-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GridNetworkSpace.generate_destinations"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GridNetworkSpace.generate_destinations-228"><a href="#GridNetworkSpace.generate_destinations-228"><span class="linenos">228</span></a>    <span class="k">def</span> <span class="nf">generate_destinations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probability</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
</span><span id="GridNetworkSpace.generate_destinations-229"><a href="#GridNetworkSpace.generate_destinations-229"><span class="linenos">229</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace.generate_destinations-230"><a href="#GridNetworkSpace.generate_destinations-230"><span class="linenos">230</span></a><span class="sd">        Determines which nodes in the road network should be destinations.</span>
</span><span id="GridNetworkSpace.generate_destinations-231"><a href="#GridNetworkSpace.generate_destinations-231"><span class="linenos">231</span></a><span class="sd">        Only nodes with exactly one ingoing and one outgoing edge can be a destination.</span>
</span><span id="GridNetworkSpace.generate_destinations-232"><a href="#GridNetworkSpace.generate_destinations-232"><span class="linenos">232</span></a><span class="sd">        This is to disallow destinations in crossings.</span>
</span><span id="GridNetworkSpace.generate_destinations-233"><a href="#GridNetworkSpace.generate_destinations-233"><span class="linenos">233</span></a><span class="sd">        </span>
</span><span id="GridNetworkSpace.generate_destinations-234"><a href="#GridNetworkSpace.generate_destinations-234"><span class="linenos">234</span></a><span class="sd">        Args:</span>
</span><span id="GridNetworkSpace.generate_destinations-235"><a href="#GridNetworkSpace.generate_destinations-235"><span class="linenos">235</span></a><span class="sd">            probability (float, optional): The probability that an eligible node will be selected as a destination. Defaults to 1.</span>
</span><span id="GridNetworkSpace.generate_destinations-236"><a href="#GridNetworkSpace.generate_destinations-236"><span class="linenos">236</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace.generate_destinations-237"><a href="#GridNetworkSpace.generate_destinations-237"><span class="linenos">237</span></a>        <span class="c1"># TODO: This requires some polishing.</span>
</span><span id="GridNetworkSpace.generate_destinations-238"><a href="#GridNetworkSpace.generate_destinations-238"><span class="linenos">238</span></a>        <span class="n">rnw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">road_network</span>
</span><span id="GridNetworkSpace.generate_destinations-239"><a href="#GridNetworkSpace.generate_destinations-239"><span class="linenos">239</span></a>        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">rnw</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
</span><span id="GridNetworkSpace.generate_destinations-240"><a href="#GridNetworkSpace.generate_destinations-240"><span class="linenos">240</span></a>            <span class="k">if</span> <span class="n">rnw</span><span class="o">.</span><span class="n">in_degree</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">rnw</span><span class="o">.</span><span class="n">out_degree</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">probability</span><span class="p">:</span>
</span><span id="GridNetworkSpace.generate_destinations-241"><a href="#GridNetworkSpace.generate_destinations-241"><span class="linenos">241</span></a>                <span class="n">rnw</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;destination&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="GridNetworkSpace.generate_destinations-242"><a href="#GridNetworkSpace.generate_destinations-242"><span class="linenos">242</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="GridNetworkSpace.generate_destinations-243"><a href="#GridNetworkSpace.generate_destinations-243"><span class="linenos">243</span></a>                <span class="n">rnw</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;destination&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Determines which nodes in the road network should be destinations.
Only nodes with exactly one ingoing and one outgoing edge can be a destination.
This is to disallow destinations in crossings.</p>

<p>Args:
    probability (float, optional): The probability that an eligible node will be selected as a destination. Defaults to 1.</p>
</div>


                            </div>
                            <div id="GridNetworkSpace.priority_nodes" class="classattr">
                                        <input id="GridNetworkSpace.priority_nodes-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">priority_nodes</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">from_node</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>,</span><span class="param">	<span class="n">to_node</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="GridNetworkSpace.priority_nodes-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GridNetworkSpace.priority_nodes"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GridNetworkSpace.priority_nodes-245"><a href="#GridNetworkSpace.priority_nodes-245"><span class="linenos">245</span></a>    <span class="k">def</span> <span class="nf">priority_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="n">to_node</span><span class="p">:</span> <span class="n">Node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Node</span><span class="p">]:</span>
</span><span id="GridNetworkSpace.priority_nodes-246"><a href="#GridNetworkSpace.priority_nodes-246"><span class="linenos">246</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace.priority_nodes-247"><a href="#GridNetworkSpace.priority_nodes-247"><span class="linenos">247</span></a><span class="sd">        Returns the nodes from which traffic has priority over from_node when going into to_node.</span>
</span><span id="GridNetworkSpace.priority_nodes-248"><a href="#GridNetworkSpace.priority_nodes-248"><span class="linenos">248</span></a>
</span><span id="GridNetworkSpace.priority_nodes-249"><a href="#GridNetworkSpace.priority_nodes-249"><span class="linenos">249</span></a><span class="sd">        Args:</span>
</span><span id="GridNetworkSpace.priority_nodes-250"><a href="#GridNetworkSpace.priority_nodes-250"><span class="linenos">250</span></a><span class="sd">            from_node (Node): the node to be checked for priority.</span>
</span><span id="GridNetworkSpace.priority_nodes-251"><a href="#GridNetworkSpace.priority_nodes-251"><span class="linenos">251</span></a><span class="sd">            to_node (Node): the node to be checked for priority.</span>
</span><span id="GridNetworkSpace.priority_nodes-252"><a href="#GridNetworkSpace.priority_nodes-252"><span class="linenos">252</span></a>
</span><span id="GridNetworkSpace.priority_nodes-253"><a href="#GridNetworkSpace.priority_nodes-253"><span class="linenos">253</span></a><span class="sd">        Returns:</span>
</span><span id="GridNetworkSpace.priority_nodes-254"><a href="#GridNetworkSpace.priority_nodes-254"><span class="linenos">254</span></a><span class="sd">            List[Node]: a list of nodes from which vehicles have priority.</span>
</span><span id="GridNetworkSpace.priority_nodes-255"><a href="#GridNetworkSpace.priority_nodes-255"><span class="linenos">255</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GridNetworkSpace.priority_nodes-256"><a href="#GridNetworkSpace.priority_nodes-256"><span class="linenos">256</span></a>        <span class="c1"># In a roundabout, W has priority over S, S over E, E over N and N over W.</span>
</span><span id="GridNetworkSpace.priority_nodes-257"><a href="#GridNetworkSpace.priority_nodes-257"><span class="linenos">257</span></a>        <span class="n">priority_rule</span> <span class="o">=</span> <span class="p">{</span> <span class="s2">&quot;W&quot;</span> <span class="p">:</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span> <span class="p">:</span> <span class="s2">&quot;E&quot;</span><span class="p">,</span> <span class="s2">&quot;E&quot;</span> <span class="p">:</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span> <span class="p">:</span> <span class="s2">&quot;W&quot;</span> <span class="p">}</span>
</span><span id="GridNetworkSpace.priority_nodes-258"><a href="#GridNetworkSpace.priority_nodes-258"><span class="linenos">258</span></a>
</span><span id="GridNetworkSpace.priority_nodes-259"><a href="#GridNetworkSpace.priority_nodes-259"><span class="linenos">259</span></a>        <span class="c1"># Determine which node has priority entering to_node.</span>
</span><span id="GridNetworkSpace.priority_nodes-260"><a href="#GridNetworkSpace.priority_nodes-260"><span class="linenos">260</span></a>        <span class="n">priority_direction</span> <span class="o">=</span> <span class="n">priority_rule</span><span class="p">[</span><span class="n">direction</span><span class="p">(</span><span class="n">from_node</span><span class="p">,</span> <span class="n">to_node</span><span class="p">)]</span>
</span><span id="GridNetworkSpace.priority_nodes-261"><a href="#GridNetworkSpace.priority_nodes-261"><span class="linenos">261</span></a>        <span class="n">priority_node</span> <span class="o">=</span> <span class="n">node_to</span><span class="p">(</span><span class="n">to_node</span><span class="p">,</span> <span class="n">priority_direction</span><span class="p">)</span>
</span><span id="GridNetworkSpace.priority_nodes-262"><a href="#GridNetworkSpace.priority_nodes-262"><span class="linenos">262</span></a>
</span><span id="GridNetworkSpace.priority_nodes-263"><a href="#GridNetworkSpace.priority_nodes-263"><span class="linenos">263</span></a>        <span class="c1"># If the priority node can reach to_node, return it, otherwise return nothing.</span>
</span><span id="GridNetworkSpace.priority_nodes-264"><a href="#GridNetworkSpace.priority_nodes-264"><span class="linenos">264</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">road_network</span><span class="o">.</span><span class="n">has_edge</span><span class="p">(</span><span class="n">priority_node</span><span class="p">,</span> <span class="n">to_node</span><span class="p">):</span>
</span><span id="GridNetworkSpace.priority_nodes-265"><a href="#GridNetworkSpace.priority_nodes-265"><span class="linenos">265</span></a>            <span class="k">return</span> <span class="p">[</span><span class="n">priority_node</span><span class="p">]</span>
</span><span id="GridNetworkSpace.priority_nodes-266"><a href="#GridNetworkSpace.priority_nodes-266"><span class="linenos">266</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="GridNetworkSpace.priority_nodes-267"><a href="#GridNetworkSpace.priority_nodes-267"><span class="linenos">267</span></a>            <span class="k">return</span> <span class="p">[]</span>
</span></pre></div>


            <div class="docstring"><p>Returns the nodes from which traffic has priority over from_node when going into to_node.</p>

<p>Args:
    from_node (Node): the node to be checked for priority.
    to_node (Node): the node to be checked for priority.</p>

<p>Returns:
    List[Node]: a list of nodes from which vehicles have priority.</p>
</div>


                            </div>
                </section>
                <section id="Vehicle">
                            <input id="Vehicle-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Vehicle</span><wbr>(<span class="base">mesa.agent.Agent</span>):

                <label class="view-source-button" for="Vehicle-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Vehicle"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Vehicle-269"><a href="#Vehicle-269"><span class="linenos">269</span></a><span class="k">class</span> <span class="nc">Vehicle</span><span class="p">(</span><span class="n">mesa</span><span class="o">.</span><span class="n">Agent</span><span class="p">):</span>
</span><span id="Vehicle-270"><a href="#Vehicle-270"><span class="linenos">270</span></a>
</span><span id="Vehicle-271"><a href="#Vehicle-271"><span class="linenos">271</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unique_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">mesa</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span><span id="Vehicle-272"><a href="#Vehicle-272"><span class="linenos">272</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Vehicle-273"><a href="#Vehicle-273"><span class="linenos">273</span></a><span class="sd">        Creates a vehicle agent in a simulation model.</span>
</span><span id="Vehicle-274"><a href="#Vehicle-274"><span class="linenos">274</span></a>
</span><span id="Vehicle-275"><a href="#Vehicle-275"><span class="linenos">275</span></a><span class="sd">        Args:</span>
</span><span id="Vehicle-276"><a href="#Vehicle-276"><span class="linenos">276</span></a><span class="sd">            unique_id (int): the unique id of the agent.</span>
</span><span id="Vehicle-277"><a href="#Vehicle-277"><span class="linenos">277</span></a><span class="sd">            model (mesa.Model): the model in which the agent is situated.</span>
</span><span id="Vehicle-278"><a href="#Vehicle-278"><span class="linenos">278</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Vehicle-279"><a href="#Vehicle-279"><span class="linenos">279</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">unique_id</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
</span><span id="Vehicle-280"><a href="#Vehicle-280"><span class="linenos">280</span></a>        <span class="c1"># Add a load capacity of the vehicle</span>
</span><span id="Vehicle-281"><a href="#Vehicle-281"><span class="linenos">281</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span><span id="Vehicle-282"><a href="#Vehicle-282"><span class="linenos">282</span></a>
</span><span id="Vehicle-283"><a href="#Vehicle-283"><span class="linenos">283</span></a>        <span class="c1"># Randomly select a starting position which is not yet occupied by some other vehicle.</span>
</span><span id="Vehicle-284"><a href="#Vehicle-284"><span class="linenos">284</span></a>        <span class="n">rnw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">road_network</span>
</span><span id="Vehicle-285"><a href="#Vehicle-285"><span class="linenos">285</span></a>        <span class="n">available_positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">rnw</span><span class="o">.</span><span class="n">nodes</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">rnw</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s2">&quot;agent&quot;</span><span class="p">]]</span>
</span><span id="Vehicle-286"><a href="#Vehicle-286"><span class="linenos">286</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">available_positions</span><span class="p">)</span>
</span><span id="Vehicle-287"><a href="#Vehicle-287"><span class="linenos">287</span></a>        <span class="n">rnw</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">][</span><span class="s2">&quot;agent&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Vehicle-288"><a href="#Vehicle-288"><span class="linenos">288</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">new_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span>
</span><span id="Vehicle-289"><a href="#Vehicle-289"><span class="linenos">289</span></a>
</span><span id="Vehicle-290"><a href="#Vehicle-290"><span class="linenos">290</span></a>        <span class="c1"># Set the initial heading of the vehicle.</span>
</span><span id="Vehicle-291"><a href="#Vehicle-291"><span class="linenos">291</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">heading</span> <span class="o">=</span> <span class="n">rnw</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">][</span><span class="nb">next</span><span class="p">(</span><span class="n">rnw</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">))][</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span>
</span><span id="Vehicle-292"><a href="#Vehicle-292"><span class="linenos">292</span></a>
</span><span id="Vehicle-293"><a href="#Vehicle-293"><span class="linenos">293</span></a>        <span class="c1"># Add a view</span>
</span><span id="Vehicle-294"><a href="#Vehicle-294"><span class="linenos">294</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">view</span><span class="p">:</span>
</span><span id="Vehicle-295"><a href="#Vehicle-295"><span class="linenos">295</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">create_agent_view</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Vehicle-296"><a href="#Vehicle-296"><span class="linenos">296</span></a>
</span><span id="Vehicle-297"><a href="#Vehicle-297"><span class="linenos">297</span></a>        <span class="c1"># Add a plan, which is a list of capability instances.</span>
</span><span id="Vehicle-298"><a href="#Vehicle-298"><span class="linenos">298</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plan</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Vehicle-299"><a href="#Vehicle-299"><span class="linenos">299</span></a>
</span><span id="Vehicle-300"><a href="#Vehicle-300"><span class="linenos">300</span></a>    <span class="k">def</span> <span class="nf">create_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Vehicle-301"><a href="#Vehicle-301"><span class="linenos">301</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Vehicle-302"><a href="#Vehicle-302"><span class="linenos">302</span></a><span class="sd">        The vehicle creates a plan, which consists of randomly moving to one the neighbours in the road network.</span>
</span><span id="Vehicle-303"><a href="#Vehicle-303"><span class="linenos">303</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Vehicle-304"><a href="#Vehicle-304"><span class="linenos">304</span></a>        <span class="n">rnw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">road_network</span>
</span><span id="Vehicle-305"><a href="#Vehicle-305"><span class="linenos">305</span></a>        <span class="n">new_pos</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">rnw</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)))</span>
</span><span id="Vehicle-306"><a href="#Vehicle-306"><span class="linenos">306</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plan</span> <span class="o">=</span> <span class="p">[</span><span class="n">capabilities</span><span class="o">.</span><span class="n">MoveCapability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_pos</span><span class="p">)]</span>
</span><span id="Vehicle-307"><a href="#Vehicle-307"><span class="linenos">307</span></a>
</span><span id="Vehicle-308"><a href="#Vehicle-308"><span class="linenos">308</span></a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Vehicle-309"><a href="#Vehicle-309"><span class="linenos">309</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Vehicle-310"><a href="#Vehicle-310"><span class="linenos">310</span></a><span class="sd">        The first part of a simulation round when using the Mesa simultaneous activation scheduler.</span>
</span><span id="Vehicle-311"><a href="#Vehicle-311"><span class="linenos">311</span></a><span class="sd">        If the agent does not have a plan, it creates one.</span>
</span><span id="Vehicle-312"><a href="#Vehicle-312"><span class="linenos">312</span></a><span class="sd">        Then it checks that the preconditions of the first action in the plan are fulfilled.</span>
</span><span id="Vehicle-313"><a href="#Vehicle-313"><span class="linenos">313</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Vehicle-314"><a href="#Vehicle-314"><span class="linenos">314</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">:</span>
</span><span id="Vehicle-315"><a href="#Vehicle-315"><span class="linenos">315</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">create_plan</span><span class="p">()</span>
</span><span id="Vehicle-316"><a href="#Vehicle-316"><span class="linenos">316</span></a>        <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Vehicle-317"><a href="#Vehicle-317"><span class="linenos">317</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ready_to_advance</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">precondition</span><span class="p">()</span>
</span><span id="Vehicle-318"><a href="#Vehicle-318"><span class="linenos">318</span></a>
</span><span id="Vehicle-319"><a href="#Vehicle-319"><span class="linenos">319</span></a>    <span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Vehicle-320"><a href="#Vehicle-320"><span class="linenos">320</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Vehicle-321"><a href="#Vehicle-321"><span class="linenos">321</span></a><span class="sd">        The second part of a simulation round when using the Mesa simultaneous activation scheduler.</span>
</span><span id="Vehicle-322"><a href="#Vehicle-322"><span class="linenos">322</span></a><span class="sd">        If the precondition of the first action in the current plan was fullfilled, that action is now carried out.</span>
</span><span id="Vehicle-323"><a href="#Vehicle-323"><span class="linenos">323</span></a><span class="sd">        If this leads to the action&#39;s postcondition being fulfilled, the action is removed from the plan.</span>
</span><span id="Vehicle-324"><a href="#Vehicle-324"><span class="linenos">324</span></a><span class="sd">        Finally, if the agent has a view, that view is updated.</span>
</span><span id="Vehicle-325"><a href="#Vehicle-325"><span class="linenos">325</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Vehicle-326"><a href="#Vehicle-326"><span class="linenos">326</span></a>        <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Vehicle-327"><a href="#Vehicle-327"><span class="linenos">327</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ready_to_advance</span><span class="p">:</span>
</span><span id="Vehicle-328"><a href="#Vehicle-328"><span class="linenos">328</span></a>            <span class="n">action</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
</span><span id="Vehicle-329"><a href="#Vehicle-329"><span class="linenos">329</span></a>        <span class="k">if</span> <span class="n">action</span><span class="o">.</span><span class="n">postcondition</span><span class="p">():</span>
</span><span id="Vehicle-330"><a href="#Vehicle-330"><span class="linenos">330</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="Vehicle-331"><a href="#Vehicle-331"><span class="linenos">331</span></a>
</span><span id="Vehicle-332"><a href="#Vehicle-332"><span class="linenos">332</span></a>        <span class="c1"># Update the position in the drawing</span>
</span><span id="Vehicle-333"><a href="#Vehicle-333"><span class="linenos">333</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">view</span><span class="p">:</span>
</span><span id="Vehicle-334"><a href="#Vehicle-334"><span class="linenos">334</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Base class for a model agent.</p>
</div>


                            <div id="Vehicle.__init__" class="classattr">
                                        <input id="Vehicle.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Vehicle</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">unique_id</span><span class="p">:</span> <span class="nb">int</span>, </span><span class="param"><span class="n">model</span><span class="p">:</span> <span class="n">mesa</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">Model</span></span>)</span>

                <label class="view-source-button" for="Vehicle.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Vehicle.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Vehicle.__init__-271"><a href="#Vehicle.__init__-271"><span class="linenos">271</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unique_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">mesa</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span><span id="Vehicle.__init__-272"><a href="#Vehicle.__init__-272"><span class="linenos">272</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Vehicle.__init__-273"><a href="#Vehicle.__init__-273"><span class="linenos">273</span></a><span class="sd">        Creates a vehicle agent in a simulation model.</span>
</span><span id="Vehicle.__init__-274"><a href="#Vehicle.__init__-274"><span class="linenos">274</span></a>
</span><span id="Vehicle.__init__-275"><a href="#Vehicle.__init__-275"><span class="linenos">275</span></a><span class="sd">        Args:</span>
</span><span id="Vehicle.__init__-276"><a href="#Vehicle.__init__-276"><span class="linenos">276</span></a><span class="sd">            unique_id (int): the unique id of the agent.</span>
</span><span id="Vehicle.__init__-277"><a href="#Vehicle.__init__-277"><span class="linenos">277</span></a><span class="sd">            model (mesa.Model): the model in which the agent is situated.</span>
</span><span id="Vehicle.__init__-278"><a href="#Vehicle.__init__-278"><span class="linenos">278</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Vehicle.__init__-279"><a href="#Vehicle.__init__-279"><span class="linenos">279</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">unique_id</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
</span><span id="Vehicle.__init__-280"><a href="#Vehicle.__init__-280"><span class="linenos">280</span></a>        <span class="c1"># Add a load capacity of the vehicle</span>
</span><span id="Vehicle.__init__-281"><a href="#Vehicle.__init__-281"><span class="linenos">281</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
</span><span id="Vehicle.__init__-282"><a href="#Vehicle.__init__-282"><span class="linenos">282</span></a>
</span><span id="Vehicle.__init__-283"><a href="#Vehicle.__init__-283"><span class="linenos">283</span></a>        <span class="c1"># Randomly select a starting position which is not yet occupied by some other vehicle.</span>
</span><span id="Vehicle.__init__-284"><a href="#Vehicle.__init__-284"><span class="linenos">284</span></a>        <span class="n">rnw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">road_network</span>
</span><span id="Vehicle.__init__-285"><a href="#Vehicle.__init__-285"><span class="linenos">285</span></a>        <span class="n">available_positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">rnw</span><span class="o">.</span><span class="n">nodes</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">rnw</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s2">&quot;agent&quot;</span><span class="p">]]</span>
</span><span id="Vehicle.__init__-286"><a href="#Vehicle.__init__-286"><span class="linenos">286</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">available_positions</span><span class="p">)</span>
</span><span id="Vehicle.__init__-287"><a href="#Vehicle.__init__-287"><span class="linenos">287</span></a>        <span class="n">rnw</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">][</span><span class="s2">&quot;agent&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Vehicle.__init__-288"><a href="#Vehicle.__init__-288"><span class="linenos">288</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">new_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span>
</span><span id="Vehicle.__init__-289"><a href="#Vehicle.__init__-289"><span class="linenos">289</span></a>
</span><span id="Vehicle.__init__-290"><a href="#Vehicle.__init__-290"><span class="linenos">290</span></a>        <span class="c1"># Set the initial heading of the vehicle.</span>
</span><span id="Vehicle.__init__-291"><a href="#Vehicle.__init__-291"><span class="linenos">291</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">heading</span> <span class="o">=</span> <span class="n">rnw</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">][</span><span class="nb">next</span><span class="p">(</span><span class="n">rnw</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">))][</span><span class="s2">&quot;direction&quot;</span><span class="p">]</span>
</span><span id="Vehicle.__init__-292"><a href="#Vehicle.__init__-292"><span class="linenos">292</span></a>
</span><span id="Vehicle.__init__-293"><a href="#Vehicle.__init__-293"><span class="linenos">293</span></a>        <span class="c1"># Add a view</span>
</span><span id="Vehicle.__init__-294"><a href="#Vehicle.__init__-294"><span class="linenos">294</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">view</span><span class="p">:</span>
</span><span id="Vehicle.__init__-295"><a href="#Vehicle.__init__-295"><span class="linenos">295</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">create_agent_view</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="Vehicle.__init__-296"><a href="#Vehicle.__init__-296"><span class="linenos">296</span></a>
</span><span id="Vehicle.__init__-297"><a href="#Vehicle.__init__-297"><span class="linenos">297</span></a>        <span class="c1"># Add a plan, which is a list of capability instances.</span>
</span><span id="Vehicle.__init__-298"><a href="#Vehicle.__init__-298"><span class="linenos">298</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plan</span> <span class="o">=</span> <span class="p">[]</span>
</span></pre></div>


            <div class="docstring"><p>Creates a vehicle agent in a simulation model.</p>

<p>Args:
    unique_id (int): the unique id of the agent.
    model (mesa.Model): the model in which the agent is situated.</p>
</div>


                            </div>
                            <div id="Vehicle.capacity" class="classattr">
                                <div class="attr variable">
            <span class="name">capacity</span>

        
    </div>
    <a class="headerlink" href="#Vehicle.capacity"></a>
    
    

                            </div>
                            <div id="Vehicle.pos" class="classattr">
                                <div class="attr variable">
            <span class="name">pos</span>

        
    </div>
    <a class="headerlink" href="#Vehicle.pos"></a>
    
    

                            </div>
                            <div id="Vehicle.new_pos" class="classattr">
                                <div class="attr variable">
            <span class="name">new_pos</span>

        
    </div>
    <a class="headerlink" href="#Vehicle.new_pos"></a>
    
    

                            </div>
                            <div id="Vehicle.heading" class="classattr">
                                <div class="attr variable">
            <span class="name">heading</span>

        
    </div>
    <a class="headerlink" href="#Vehicle.heading"></a>
    
    

                            </div>
                            <div id="Vehicle.plan" class="classattr">
                                <div class="attr variable">
            <span class="name">plan</span>

        
    </div>
    <a class="headerlink" href="#Vehicle.plan"></a>
    
    

                            </div>
                            <div id="Vehicle.create_plan" class="classattr">
                                        <input id="Vehicle.create_plan-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_plan</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Vehicle.create_plan-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Vehicle.create_plan"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Vehicle.create_plan-300"><a href="#Vehicle.create_plan-300"><span class="linenos">300</span></a>    <span class="k">def</span> <span class="nf">create_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Vehicle.create_plan-301"><a href="#Vehicle.create_plan-301"><span class="linenos">301</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Vehicle.create_plan-302"><a href="#Vehicle.create_plan-302"><span class="linenos">302</span></a><span class="sd">        The vehicle creates a plan, which consists of randomly moving to one the neighbours in the road network.</span>
</span><span id="Vehicle.create_plan-303"><a href="#Vehicle.create_plan-303"><span class="linenos">303</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Vehicle.create_plan-304"><a href="#Vehicle.create_plan-304"><span class="linenos">304</span></a>        <span class="n">rnw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">space</span><span class="o">.</span><span class="n">road_network</span>
</span><span id="Vehicle.create_plan-305"><a href="#Vehicle.create_plan-305"><span class="linenos">305</span></a>        <span class="n">new_pos</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">rnw</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)))</span>
</span><span id="Vehicle.create_plan-306"><a href="#Vehicle.create_plan-306"><span class="linenos">306</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">plan</span> <span class="o">=</span> <span class="p">[</span><span class="n">capabilities</span><span class="o">.</span><span class="n">MoveCapability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_pos</span><span class="p">)]</span>
</span></pre></div>


            <div class="docstring"><p>The vehicle creates a plan, which consists of randomly moving to one the neighbours in the road network.</p>
</div>


                            </div>
                            <div id="Vehicle.step" class="classattr">
                                        <input id="Vehicle.step-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">step</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Vehicle.step-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Vehicle.step"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Vehicle.step-308"><a href="#Vehicle.step-308"><span class="linenos">308</span></a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Vehicle.step-309"><a href="#Vehicle.step-309"><span class="linenos">309</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Vehicle.step-310"><a href="#Vehicle.step-310"><span class="linenos">310</span></a><span class="sd">        The first part of a simulation round when using the Mesa simultaneous activation scheduler.</span>
</span><span id="Vehicle.step-311"><a href="#Vehicle.step-311"><span class="linenos">311</span></a><span class="sd">        If the agent does not have a plan, it creates one.</span>
</span><span id="Vehicle.step-312"><a href="#Vehicle.step-312"><span class="linenos">312</span></a><span class="sd">        Then it checks that the preconditions of the first action in the plan are fulfilled.</span>
</span><span id="Vehicle.step-313"><a href="#Vehicle.step-313"><span class="linenos">313</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Vehicle.step-314"><a href="#Vehicle.step-314"><span class="linenos">314</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">:</span>
</span><span id="Vehicle.step-315"><a href="#Vehicle.step-315"><span class="linenos">315</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">create_plan</span><span class="p">()</span>
</span><span id="Vehicle.step-316"><a href="#Vehicle.step-316"><span class="linenos">316</span></a>        <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Vehicle.step-317"><a href="#Vehicle.step-317"><span class="linenos">317</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ready_to_advance</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">precondition</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>The first part of a simulation round when using the Mesa simultaneous activation scheduler.
If the agent does not have a plan, it creates one.
Then it checks that the preconditions of the first action in the plan are fulfilled.</p>
</div>


                            </div>
                            <div id="Vehicle.advance" class="classattr">
                                        <input id="Vehicle.advance-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">advance</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Vehicle.advance-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Vehicle.advance"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Vehicle.advance-319"><a href="#Vehicle.advance-319"><span class="linenos">319</span></a>    <span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Vehicle.advance-320"><a href="#Vehicle.advance-320"><span class="linenos">320</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Vehicle.advance-321"><a href="#Vehicle.advance-321"><span class="linenos">321</span></a><span class="sd">        The second part of a simulation round when using the Mesa simultaneous activation scheduler.</span>
</span><span id="Vehicle.advance-322"><a href="#Vehicle.advance-322"><span class="linenos">322</span></a><span class="sd">        If the precondition of the first action in the current plan was fullfilled, that action is now carried out.</span>
</span><span id="Vehicle.advance-323"><a href="#Vehicle.advance-323"><span class="linenos">323</span></a><span class="sd">        If this leads to the action&#39;s postcondition being fulfilled, the action is removed from the plan.</span>
</span><span id="Vehicle.advance-324"><a href="#Vehicle.advance-324"><span class="linenos">324</span></a><span class="sd">        Finally, if the agent has a view, that view is updated.</span>
</span><span id="Vehicle.advance-325"><a href="#Vehicle.advance-325"><span class="linenos">325</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Vehicle.advance-326"><a href="#Vehicle.advance-326"><span class="linenos">326</span></a>        <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Vehicle.advance-327"><a href="#Vehicle.advance-327"><span class="linenos">327</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ready_to_advance</span><span class="p">:</span>
</span><span id="Vehicle.advance-328"><a href="#Vehicle.advance-328"><span class="linenos">328</span></a>            <span class="n">action</span><span class="o">.</span><span class="n">activate</span><span class="p">()</span>
</span><span id="Vehicle.advance-329"><a href="#Vehicle.advance-329"><span class="linenos">329</span></a>        <span class="k">if</span> <span class="n">action</span><span class="o">.</span><span class="n">postcondition</span><span class="p">():</span>
</span><span id="Vehicle.advance-330"><a href="#Vehicle.advance-330"><span class="linenos">330</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="Vehicle.advance-331"><a href="#Vehicle.advance-331"><span class="linenos">331</span></a>
</span><span id="Vehicle.advance-332"><a href="#Vehicle.advance-332"><span class="linenos">332</span></a>        <span class="c1"># Update the position in the drawing</span>
</span><span id="Vehicle.advance-333"><a href="#Vehicle.advance-333"><span class="linenos">333</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">view</span><span class="p">:</span>
</span><span id="Vehicle.advance-334"><a href="#Vehicle.advance-334"><span class="linenos">334</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>The second part of a simulation round when using the Mesa simultaneous activation scheduler.
If the precondition of the first action in the current plan was fullfilled, that action is now carried out.
If this leads to the action's postcondition being fulfilled, the action is removed from the plan.
Finally, if the agent has a view, that view is updated.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>mesa.agent.Agent</dt>
                                <dd id="Vehicle.unique_id" class="variable">unique_id</dd>
                <dd id="Vehicle.model" class="variable">model</dd>
                <dd id="Vehicle.random" class="variable">random</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="TransportSystem">
                            <input id="TransportSystem-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">TransportSystem</span><wbr>(<span class="base">mesa.model.Model</span>):

                <label class="view-source-button" for="TransportSystem-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TransportSystem"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TransportSystem-336"><a href="#TransportSystem-336"><span class="linenos">336</span></a><span class="k">class</span> <span class="nc">TransportSystem</span><span class="p">(</span><span class="n">mesa</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
</span><span id="TransportSystem-337"><a href="#TransportSystem-337"><span class="linenos">337</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="TransportSystem-338"><a href="#TransportSystem-338"><span class="linenos">338</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TransportSystem-339"><a href="#TransportSystem-339"><span class="linenos">339</span></a><span class="sd">        Creates a transport system model.</span>
</span><span id="TransportSystem-340"><a href="#TransportSystem-340"><span class="linenos">340</span></a><span class="sd">        Note that it is empty initially, and needs to be generated using the generate method.</span>
</span><span id="TransportSystem-341"><a href="#TransportSystem-341"><span class="linenos">341</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TransportSystem-342"><a href="#TransportSystem-342"><span class="linenos">342</span></a>        <span class="c1"># TODO: Initialize from a configuration object, to make it easier to edit, load, and save it.</span>
</span><span id="TransportSystem-343"><a href="#TransportSystem-343"><span class="linenos">343</span></a>        <span class="c1"># TODO: Mesa has its own random seed handling, see source code of Mesa.model. </span>
</span><span id="TransportSystem-344"><a href="#TransportSystem-344"><span class="linenos">344</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="TransportSystem-345"><a href="#TransportSystem-345"><span class="linenos">345</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_agents</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="TransportSystem-346"><a href="#TransportSystem-346"><span class="linenos">346</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="TransportSystem-347"><a href="#TransportSystem-347"><span class="linenos">347</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="TransportSystem-348"><a href="#TransportSystem-348"><span class="linenos">348</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">)</span>
</span><span id="TransportSystem-349"><a href="#TransportSystem-349"><span class="linenos">349</span></a>
</span><span id="TransportSystem-350"><a href="#TransportSystem-350"><span class="linenos">350</span></a>    <span class="k">def</span> <span class="nf">add_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
</span><span id="TransportSystem-351"><a href="#TransportSystem-351"><span class="linenos">351</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TransportSystem-352"><a href="#TransportSystem-352"><span class="linenos">352</span></a><span class="sd">        Adds a view to the model.</span>
</span><span id="TransportSystem-353"><a href="#TransportSystem-353"><span class="linenos">353</span></a>
</span><span id="TransportSystem-354"><a href="#TransportSystem-354"><span class="linenos">354</span></a><span class="sd">        Args:</span>
</span><span id="TransportSystem-355"><a href="#TransportSystem-355"><span class="linenos">355</span></a><span class="sd">            view (Any): the view to be added.</span>
</span><span id="TransportSystem-356"><a href="#TransportSystem-356"><span class="linenos">356</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TransportSystem-357"><a href="#TransportSystem-357"><span class="linenos">357</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">view</span>
</span><span id="TransportSystem-358"><a href="#TransportSystem-358"><span class="linenos">358</span></a>
</span><span id="TransportSystem-359"><a href="#TransportSystem-359"><span class="linenos">359</span></a>    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="TransportSystem-360"><a href="#TransportSystem-360"><span class="linenos">360</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TransportSystem-361"><a href="#TransportSystem-361"><span class="linenos">361</span></a><span class="sd">        Generates the model, including creating its space and agents.</span>
</span><span id="TransportSystem-362"><a href="#TransportSystem-362"><span class="linenos">362</span></a>
</span><span id="TransportSystem-363"><a href="#TransportSystem-363"><span class="linenos">363</span></a><span class="sd">        Args:</span>
</span><span id="TransportSystem-364"><a href="#TransportSystem-364"><span class="linenos">364</span></a><span class="sd">            N (int, optional): number of agents. Defaults to 10.</span>
</span><span id="TransportSystem-365"><a href="#TransportSystem-365"><span class="linenos">365</span></a><span class="sd">            width (int, optional): width of the coarse grid space. Defaults to 10.</span>
</span><span id="TransportSystem-366"><a href="#TransportSystem-366"><span class="linenos">366</span></a><span class="sd">            height (int, optional): height of the coarse grid space. Defaults to 10.</span>
</span><span id="TransportSystem-367"><a href="#TransportSystem-367"><span class="linenos">367</span></a><span class="sd">            random_seed (int | None, optional): a random seed. Defaults to None, in which case a seed is generated.</span>
</span><span id="TransportSystem-368"><a href="#TransportSystem-368"><span class="linenos">368</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TransportSystem-369"><a href="#TransportSystem-369"><span class="linenos">369</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_agents</span> <span class="o">=</span> <span class="n">N</span>
</span><span id="TransportSystem-370"><a href="#TransportSystem-370"><span class="linenos">370</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span>
</span><span id="TransportSystem-371"><a href="#TransportSystem-371"><span class="linenos">371</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span>
</span><span id="TransportSystem-372"><a href="#TransportSystem-372"><span class="linenos">372</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="n">random_seed</span> <span class="ow">or</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">)</span>
</span><span id="TransportSystem-373"><a href="#TransportSystem-373"><span class="linenos">373</span></a>        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
</span><span id="TransportSystem-374"><a href="#TransportSystem-374"><span class="linenos">374</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span> <span class="o">=</span> <span class="n">mesa</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">SimultaneousActivation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="TransportSystem-375"><a href="#TransportSystem-375"><span class="linenos">375</span></a>
</span><span id="TransportSystem-376"><a href="#TransportSystem-376"><span class="linenos">376</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">space</span> <span class="o">=</span> <span class="n">GridNetworkSpace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
</span><span id="TransportSystem-377"><a href="#TransportSystem-377"><span class="linenos">377</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">:</span>
</span><span id="TransportSystem-378"><a href="#TransportSystem-378"><span class="linenos">378</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="TransportSystem-379"><a href="#TransportSystem-379"><span class="linenos">379</span></a>        <span class="c1"># Create agents</span>
</span><span id="TransportSystem-380"><a href="#TransportSystem-380"><span class="linenos">380</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_agents</span><span class="p">):</span>
</span><span id="TransportSystem-381"><a href="#TransportSystem-381"><span class="linenos">381</span></a>            <span class="n">a</span> <span class="o">=</span> <span class="n">Vehicle</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span><span id="TransportSystem-382"><a href="#TransportSystem-382"><span class="linenos">382</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span><span id="TransportSystem-383"><a href="#TransportSystem-383"><span class="linenos">383</span></a>
</span><span id="TransportSystem-384"><a href="#TransportSystem-384"><span class="linenos">384</span></a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="TransportSystem-385"><a href="#TransportSystem-385"><span class="linenos">385</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TransportSystem-386"><a href="#TransportSystem-386"><span class="linenos">386</span></a><span class="sd">        Performs a simulation step and updates the views.</span>
</span><span id="TransportSystem-387"><a href="#TransportSystem-387"><span class="linenos">387</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TransportSystem-388"><a href="#TransportSystem-388"><span class="linenos">388</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="TransportSystem-389"><a href="#TransportSystem-389"><span class="linenos">389</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">:</span>
</span><span id="TransportSystem-390"><a href="#TransportSystem-390"><span class="linenos">390</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">update_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Base class for models.</p>
</div>


                            <div id="TransportSystem.__init__" class="classattr">
                                        <input id="TransportSystem.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">TransportSystem</span><span class="signature pdoc-code condensed">()</span>

                <label class="view-source-button" for="TransportSystem.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TransportSystem.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TransportSystem.__init__-337"><a href="#TransportSystem.__init__-337"><span class="linenos">337</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="TransportSystem.__init__-338"><a href="#TransportSystem.__init__-338"><span class="linenos">338</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TransportSystem.__init__-339"><a href="#TransportSystem.__init__-339"><span class="linenos">339</span></a><span class="sd">        Creates a transport system model.</span>
</span><span id="TransportSystem.__init__-340"><a href="#TransportSystem.__init__-340"><span class="linenos">340</span></a><span class="sd">        Note that it is empty initially, and needs to be generated using the generate method.</span>
</span><span id="TransportSystem.__init__-341"><a href="#TransportSystem.__init__-341"><span class="linenos">341</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TransportSystem.__init__-342"><a href="#TransportSystem.__init__-342"><span class="linenos">342</span></a>        <span class="c1"># TODO: Initialize from a configuration object, to make it easier to edit, load, and save it.</span>
</span><span id="TransportSystem.__init__-343"><a href="#TransportSystem.__init__-343"><span class="linenos">343</span></a>        <span class="c1"># TODO: Mesa has its own random seed handling, see source code of Mesa.model. </span>
</span><span id="TransportSystem.__init__-344"><a href="#TransportSystem.__init__-344"><span class="linenos">344</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="TransportSystem.__init__-345"><a href="#TransportSystem.__init__-345"><span class="linenos">345</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_agents</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="TransportSystem.__init__-346"><a href="#TransportSystem.__init__-346"><span class="linenos">346</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="TransportSystem.__init__-347"><a href="#TransportSystem.__init__-347"><span class="linenos">347</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="TransportSystem.__init__-348"><a href="#TransportSystem.__init__-348"><span class="linenos">348</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Creates a transport system model.
Note that it is empty initially, and needs to be generated using the generate method.</p>
</div>


                            </div>
                            <div id="TransportSystem.view" class="classattr">
                                <div class="attr variable">
            <span class="name">view</span>

        
    </div>
    <a class="headerlink" href="#TransportSystem.view"></a>
    
    

                            </div>
                            <div id="TransportSystem.num_agents" class="classattr">
                                <div class="attr variable">
            <span class="name">num_agents</span>

        
    </div>
    <a class="headerlink" href="#TransportSystem.num_agents"></a>
    
    

                            </div>
                            <div id="TransportSystem.width" class="classattr">
                                <div class="attr variable">
            <span class="name">width</span>

        
    </div>
    <a class="headerlink" href="#TransportSystem.width"></a>
    
    

                            </div>
                            <div id="TransportSystem.height" class="classattr">
                                <div class="attr variable">
            <span class="name">height</span>

        
    </div>
    <a class="headerlink" href="#TransportSystem.height"></a>
    
    

                            </div>
                            <div id="TransportSystem.random_seed" class="classattr">
                                <div class="attr variable">
            <span class="name">random_seed</span>

        
    </div>
    <a class="headerlink" href="#TransportSystem.random_seed"></a>
    
    

                            </div>
                            <div id="TransportSystem.add_view" class="classattr">
                                        <input id="TransportSystem.add_view-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_view</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">view</span><span class="p">:</span> <span class="n">Any</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="TransportSystem.add_view-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TransportSystem.add_view"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TransportSystem.add_view-350"><a href="#TransportSystem.add_view-350"><span class="linenos">350</span></a>    <span class="k">def</span> <span class="nf">add_view</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
</span><span id="TransportSystem.add_view-351"><a href="#TransportSystem.add_view-351"><span class="linenos">351</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TransportSystem.add_view-352"><a href="#TransportSystem.add_view-352"><span class="linenos">352</span></a><span class="sd">        Adds a view to the model.</span>
</span><span id="TransportSystem.add_view-353"><a href="#TransportSystem.add_view-353"><span class="linenos">353</span></a>
</span><span id="TransportSystem.add_view-354"><a href="#TransportSystem.add_view-354"><span class="linenos">354</span></a><span class="sd">        Args:</span>
</span><span id="TransportSystem.add_view-355"><a href="#TransportSystem.add_view-355"><span class="linenos">355</span></a><span class="sd">            view (Any): the view to be added.</span>
</span><span id="TransportSystem.add_view-356"><a href="#TransportSystem.add_view-356"><span class="linenos">356</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TransportSystem.add_view-357"><a href="#TransportSystem.add_view-357"><span class="linenos">357</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">view</span> <span class="o">=</span> <span class="n">view</span>
</span></pre></div>


            <div class="docstring"><p>Adds a view to the model.</p>

<p>Args:
    view (Any): the view to be added.</p>
</div>


                            </div>
                            <div id="TransportSystem.generate" class="classattr">
                                        <input id="TransportSystem.generate-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">N</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>,</span><span class="param">	<span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>,</span><span class="param">	<span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>,</span><span class="param">	<span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="TransportSystem.generate-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TransportSystem.generate"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TransportSystem.generate-359"><a href="#TransportSystem.generate-359"><span class="linenos">359</span></a>    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="TransportSystem.generate-360"><a href="#TransportSystem.generate-360"><span class="linenos">360</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TransportSystem.generate-361"><a href="#TransportSystem.generate-361"><span class="linenos">361</span></a><span class="sd">        Generates the model, including creating its space and agents.</span>
</span><span id="TransportSystem.generate-362"><a href="#TransportSystem.generate-362"><span class="linenos">362</span></a>
</span><span id="TransportSystem.generate-363"><a href="#TransportSystem.generate-363"><span class="linenos">363</span></a><span class="sd">        Args:</span>
</span><span id="TransportSystem.generate-364"><a href="#TransportSystem.generate-364"><span class="linenos">364</span></a><span class="sd">            N (int, optional): number of agents. Defaults to 10.</span>
</span><span id="TransportSystem.generate-365"><a href="#TransportSystem.generate-365"><span class="linenos">365</span></a><span class="sd">            width (int, optional): width of the coarse grid space. Defaults to 10.</span>
</span><span id="TransportSystem.generate-366"><a href="#TransportSystem.generate-366"><span class="linenos">366</span></a><span class="sd">            height (int, optional): height of the coarse grid space. Defaults to 10.</span>
</span><span id="TransportSystem.generate-367"><a href="#TransportSystem.generate-367"><span class="linenos">367</span></a><span class="sd">            random_seed (int | None, optional): a random seed. Defaults to None, in which case a seed is generated.</span>
</span><span id="TransportSystem.generate-368"><a href="#TransportSystem.generate-368"><span class="linenos">368</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TransportSystem.generate-369"><a href="#TransportSystem.generate-369"><span class="linenos">369</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_agents</span> <span class="o">=</span> <span class="n">N</span>
</span><span id="TransportSystem.generate-370"><a href="#TransportSystem.generate-370"><span class="linenos">370</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span>
</span><span id="TransportSystem.generate-371"><a href="#TransportSystem.generate-371"><span class="linenos">371</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span>
</span><span id="TransportSystem.generate-372"><a href="#TransportSystem.generate-372"><span class="linenos">372</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="n">random_seed</span> <span class="ow">or</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">)</span>
</span><span id="TransportSystem.generate-373"><a href="#TransportSystem.generate-373"><span class="linenos">373</span></a>        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
</span><span id="TransportSystem.generate-374"><a href="#TransportSystem.generate-374"><span class="linenos">374</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span> <span class="o">=</span> <span class="n">mesa</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">SimultaneousActivation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="TransportSystem.generate-375"><a href="#TransportSystem.generate-375"><span class="linenos">375</span></a>
</span><span id="TransportSystem.generate-376"><a href="#TransportSystem.generate-376"><span class="linenos">376</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">space</span> <span class="o">=</span> <span class="n">GridNetworkSpace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
</span><span id="TransportSystem.generate-377"><a href="#TransportSystem.generate-377"><span class="linenos">377</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">:</span>
</span><span id="TransportSystem.generate-378"><a href="#TransportSystem.generate-378"><span class="linenos">378</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="TransportSystem.generate-379"><a href="#TransportSystem.generate-379"><span class="linenos">379</span></a>        <span class="c1"># Create agents</span>
</span><span id="TransportSystem.generate-380"><a href="#TransportSystem.generate-380"><span class="linenos">380</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_agents</span><span class="p">):</span>
</span><span id="TransportSystem.generate-381"><a href="#TransportSystem.generate-381"><span class="linenos">381</span></a>            <span class="n">a</span> <span class="o">=</span> <span class="n">Vehicle</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span><span id="TransportSystem.generate-382"><a href="#TransportSystem.generate-382"><span class="linenos">382</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Generates the model, including creating its space and agents.</p>

<p>Args:
    N (int, optional): number of agents. Defaults to 10.
    width (int, optional): width of the coarse grid space. Defaults to 10.
    height (int, optional): height of the coarse grid space. Defaults to 10.
    random_seed (int | None, optional): a random seed. Defaults to None, in which case a seed is generated.</p>
</div>


                            </div>
                            <div id="TransportSystem.step" class="classattr">
                                        <input id="TransportSystem.step-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">step</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="TransportSystem.step-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TransportSystem.step"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TransportSystem.step-384"><a href="#TransportSystem.step-384"><span class="linenos">384</span></a>    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="TransportSystem.step-385"><a href="#TransportSystem.step-385"><span class="linenos">385</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="TransportSystem.step-386"><a href="#TransportSystem.step-386"><span class="linenos">386</span></a><span class="sd">        Performs a simulation step and updates the views.</span>
</span><span id="TransportSystem.step-387"><a href="#TransportSystem.step-387"><span class="linenos">387</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TransportSystem.step-388"><a href="#TransportSystem.step-388"><span class="linenos">388</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="TransportSystem.step-389"><a href="#TransportSystem.step-389"><span class="linenos">389</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="p">:</span>
</span><span id="TransportSystem.step-390"><a href="#TransportSystem.step-390"><span class="linenos">390</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">view</span><span class="o">.</span><span class="n">update_time</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Performs a simulation step and updates the views.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>mesa.model.Model</dt>
                                <dd id="TransportSystem.running" class="variable">running</dd>
                <dd id="TransportSystem.schedule" class="variable">schedule</dd>
                <dd id="TransportSystem.current_id" class="variable">current_id</dd>
                <dd id="TransportSystem.run_model" class="function">run_model</dd>
                <dd id="TransportSystem.next_id" class="function">next_id</dd>
                <dd id="TransportSystem.reset_randomizer" class="function">reset_randomizer</dd>
                <dd id="TransportSystem.initialize_data_collector" class="function">initialize_data_collector</dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>